<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL HUB - Sistema de Monitoreo</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0d1117; 
            color: #c9d1d9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #30363d;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #58a6ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #da3633;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #3fb950;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        
        .card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            padding: 25px; 
            border-radius: 8px; 
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: #58a6ff;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats { 
            font-size: 2.5rem; 
            color: #58a6ff; 
            font-weight: bold;
        }
        
        .stats.warning {
            color: #ffa657;
        }
        
        .stats.danger {
            color: #da3633;
        }
        
        .panic { 
            background: #da3633; 
            color: white; 
            border: none; 
            padding: 20px; 
            width: 100%; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px;
            font-size: 1.1rem;
            transition: background 0.2s, transform 0.1s;
        }
        
        .panic:hover {
            background: #b62324;
            transform: scale(1.02);
        }
        
        .panic:active {
            transform: scale(0.98);
        }
        
        .panic:disabled {
            background: #30363d;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .console-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .console-container {
                grid-template-columns: 1fr;
            }
        }
        
        .console-wrapper {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        
        .console-wrapper h3 {
            margin-bottom: 10px;
            color: #58a6ff;
            font-size: 1.1rem;
        }
        
        .console { 
            background: #000; 
            color: #39ff14; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 6px; 
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .console::-webkit-scrollbar {
            width: 8px;
        }
        
        .console::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .console::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        
        .console::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        .empty-state {
            color: #484f58;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #161b22;
        }
        
        .alert.error {
            border-color: #da3633;
            color: #f85149;
        }
        
        .alert.warning {
            border-color: #ffa657;
            color: #ffa657;
        }
        
        .alert.info {
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        /* Estilos para entradas de red */
        .network-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .network-entry.safe {
            color: #39ff14;
        }
        
        .network-entry.warning {
            color: #ffa657;
        }
        
        .network-entry.danger {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .network-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .network-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .network-protocol {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .network-state {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin: 0 4px;
        }
        
        .network-state.estab {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .network-state.syn-sent {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        .network-state.listen {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        /* Estilos para archivos según riesgo */
        .file-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .file-entry.low {
            color: #39ff14;
        }
        
        .file-entry.medium {
            color: #ffa657;
        }
        
        .file-entry.high {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .file-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
        }
        
        .file-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .file-path {
            word-break: break-all;
        }
        
        .file-event {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        
        .file-event.modify {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        .file-event.create {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .file-event.delete {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        /* Estilos para procesos */
        .process-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .process-entry.critical {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.15);
        }
        
        .process-entry.high {
            border-color: #f85149;
            background: rgba(248, 81, 73, 0.1);
        }
        
        .process-pid {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .process-metrics {
            color: #8b949e;
            font-size: 0.8rem;
            margin: 4px 0;
        }
        
        .process-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
        
        .process-reason {
            color: #ffa657;
            font-weight: bold;
            margin-top: 4px;
        }
        
        /* Estilos para crontab */
        .crontab-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #f85149;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .crontab-user {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .crontab-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🛰️ SISTEMA SENTINEL</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectando...</span>
        </div>
    </div>
    
    <div id="alertContainer"></div>
    
    <div class="grid">
        <div class="card">
            <div class="card-title">CPU</div>
            <div id="cpu" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Memoria</div>
            <div id="mem" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Nivel de Amenaza</div>
            <div id="threat" class="stats warning">BAJA</div>
        </div>
    </div>
    
    <button class="panic" id="panicBtn" onclick="triggerPanic()">🚨 PROTOCOLO DE PÁNICO</button>
    
    <div class="console-container">
        <div class="console-wrapper">
            <h3>🌐 RED</h3>
            <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
        </div>
        <div class="console-wrapper">
            <h3>📂 ARCHIVOS</h3>
            <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
        </div>
    </div>
    
    <div class="console-container" style="margin-top: 20px;">
        <div class="console-wrapper">
            <h3>⚙️ PROCESOS PHP SOSPECHOSOS</h3>
            <div id="process" class="console"><span class="empty-state">No se detectaron procesos sospechosos...</span></div>
        </div>
        <div class="console-wrapper">
            <h3>⏰ CRONTAB</h3>
            <div id="crontab" class="console"><span class="empty-state">No se detectaron tareas sospechosas...</span></div>
        </div>
    </div>
    
    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        
        function initSocket() {
            // Conectar solo a localhost
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: Infinity,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('✅ Conectado al servidor');
                updateStatus(true);
                reconnectAttempts = 0;
                showAlert('Conectado al servidor Sentinel', 'info');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('❌ Desconectado:', reason);
                updateStatus(false);
                if (reason === 'io server disconnect') {
                    showAlert('Desconectado por el servidor. Reconectando...', 'warning');
                } else {
                    showAlert('Conexión perdida. Reconectando...', 'warning');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('❌ Error de conexión:', error);
                updateStatus(false);
                reconnectAttempts++;
                if (reconnectAttempts <= maxReconnectAttempts) {
                    showAlert(`Error de conexión (${reconnectAttempts}/${maxReconnectAttempts}). Reintentando...`, 'error');
                } else {
                    showAlert('No se pudo conectar al servidor. Verifica que esté ejecutándose.', 'error');
                }
            });
            
            socket.on('ui_health', (data) => {
                if (data && typeof data === 'object' && data.cpu !== undefined && data.mem !== undefined) {
                    updateHealth(data);
                }
            });
            
            socket.on('ui_network', (data) => {
                if (data && typeof data === 'string') {
                    updateNetwork(data);
                }
            });
            
            socket.on('ui_file', (data) => {
                if (data && typeof data === 'object' && data.detail) {
                    updateFiles(data);
                }
            });
            
            socket.on('ui_process', (data) => {
                if (data && Array.isArray(data)) {
                    updateProcesses(data);
                }
            });
            
            socket.on('ui_crontab', (data) => {
                if (data && Array.isArray(data)) {
                    updateCrontab(data);
                }
            });
        }
        
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }
        
        function updateHealth(data) {
            const cpuEl = document.getElementById('cpu');
            const memEl = document.getElementById('mem');
            
            const cpu = parseFloat(data.cpu) || 0;
            const mem = parseFloat(data.mem) || 0;
            
            cpuEl.textContent = cpu.toFixed(1) + '%';
            memEl.textContent = mem.toFixed(1) + '%';
            
            // Cambiar color según el uso
            cpuEl.className = 'stats';
            memEl.className = 'stats';
            
            if (cpu > 80) cpuEl.classList.add('danger');
            else if (cpu > 60) cpuEl.classList.add('warning');
            
            if (mem > 80) memEl.classList.add('danger');
            else if (mem > 60) memEl.classList.add('warning');
        }
        
        function updateNetwork(data) {
            const netEl = document.getElementById('net');
            const threatEl = document.getElementById('threat');
            
            // Limpiar empty state si existe
            if (netEl.querySelector('.empty-state')) {
                netEl.innerHTML = '';
            }
            
            // Parsear y formatear las conexiones de red
            const lines = data.split('\n').filter(line => line.trim());
            let hasThreat = false;
            let threatLevel = 'BAJA';
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                const entry = document.createElement('div');
                entry.className = 'network-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'network-timestamp';
                timestampSpan.textContent = `[${timestamp}]`;
                entry.appendChild(timestampSpan);
                
                // Detectar tipo de conexión y nivel de amenaza
                let riskLevel = 'safe';
                let stateClass = '';
                let stateText = '';
                
                if (line.includes('SYN-SENT') || line.includes('SYN_SENT')) {
                    riskLevel = 'critical';
                    hasThreat = true;
                    threatLevel = 'CRÍTICA';
                    stateClass = 'syn-sent';
                    stateText = 'SYN-SENT';
                } else if (line.includes('ESTAB') || line.includes('ESTABLISHED')) {
                    // Verificar si es conexión externa sospechosa
                    const hasExternalIP = /(\d{1,3}\.){3}\d{1,3}/.test(line);
                    const isLocalhost = line.includes('127.0.0.1') || line.includes('::1');
                    
                    if (hasExternalIP && !isLocalhost) {
                        // Verificar si es PHP u otro proceso sospechoso
                        if (line.includes('php') || line.includes('python') || line.includes('perl')) {
                            riskLevel = 'danger';
                            hasThreat = true;
                            if (threatLevel !== 'CRÍTICA') threatLevel = 'ALTA';
                        } else {
                            riskLevel = 'warning';
                            if (threatLevel === 'BAJA') threatLevel = 'MEDIA';
                        }
                    }
                    stateClass = 'estab';
                    stateText = 'ESTAB';
                } else if (line.includes('LISTEN')) {
                    stateClass = 'listen';
                    stateText = 'LISTEN';
                }
                
                entry.classList.add(riskLevel);
                
                // Extraer información de la línea
                const protocolMatch = line.match(/(tcp|udp|tcp6|udp6)/i);
                const protocol = protocolMatch ? protocolMatch[1].toUpperCase() : 'TCP';
                
                const protocolSpan = document.createElement('span');
                protocolSpan.className = 'network-protocol';
                protocolSpan.textContent = protocol;
                entry.appendChild(protocolSpan);
                
                if (stateText) {
                    const stateSpan = document.createElement('span');
                    stateSpan.className = `network-state ${stateClass}`;
                    stateSpan.textContent = stateText;
                    entry.appendChild(stateSpan);
                }
                
                // Agregar información de la conexión
                const infoSpan = document.createElement('span');
                infoSpan.style.marginLeft = '8px';
                infoSpan.style.color = '#c9d1d9';
                
                // Limpiar y formatear la información
                let cleanLine = line.replace(/\s+/g, ' ').trim();
                // Remover información redundante
                cleanLine = cleanLine.replace(/users:\([^)]+\)/g, '').trim();
                infoSpan.textContent = cleanLine;
                entry.appendChild(infoSpan);
                
                // Insertar al principio
                if (netEl.firstChild) {
                    netEl.insertBefore(entry, netEl.firstChild);
                } else {
                    netEl.appendChild(entry);
                }
            });
            
            // Limitar a 50 entradas
            while (netEl.children.length > 50) {
                netEl.removeChild(netEl.lastChild);
            }
            
            // Actualizar nivel de amenaza
            threatEl.textContent = threatLevel;
            if (hasThreat) {
                threatEl.className = 'stats danger';
            } else if (threatLevel === 'MEDIA') {
                threatEl.className = 'stats warning';
            } else {
                threatEl.className = 'stats warning';
            }
        }
        
        function updateFiles(data) {
            const fileEl = document.getElementById('file');
            
            // Limpiar empty state si existe
            if (fileEl.querySelector('.empty-state')) {
                fileEl.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            
            // Determinar nivel de riesgo
            const risk = data.risk || 'low';
            entry.classList.add(risk);
            
            const timestamp = new Date(data.ts).toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'file-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            entry.appendChild(timestampSpan);
            
            // Información del archivo
            const filePath = data.filePath || data.detail.split(' ')[0] || data.detail;
            const events = data.events || (data.detail.includes('MODIFY') ? 'MODIFY' : 
                          data.detail.includes('CREATE') ? 'CREATE' : 
                          data.detail.includes('DELETE') ? 'DELETE' : 'MODIFY');
            
            const pathSpan = document.createElement('span');
            pathSpan.className = 'file-path';
            pathSpan.textContent = filePath;
            entry.appendChild(pathSpan);
            
            // Badge de evento
            const eventSpan = document.createElement('span');
            eventSpan.className = `file-event ${events.toLowerCase()}`;
            eventSpan.textContent = events;
            entry.appendChild(eventSpan);
            
            // Insertar al principio
            if (fileEl.firstChild) {
                fileEl.insertBefore(entry, fileEl.firstChild);
            } else {
                fileEl.appendChild(entry);
            }
            
            // Limitar a 50 entradas
            while (fileEl.children.length > 50) {
                fileEl.removeChild(fileEl.lastChild);
            }
        }
        
        function triggerPanic() {
            if (confirm('⚠️ ¿Estás seguro de activar el PROTOCOLO DE PÁNICO?\n\nEsto bloqueará todas las conexiones salientes excepto SSH y localhost.')) {
                if (socket && socket.connected) {
                    socket.emit('panic_action');
                    showAlert('🚨 Protocolo de pánico activado', 'error');
                } else {
                    showAlert('Error: No hay conexión con el servidor', 'error');
                }
            }
        }
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-ocultar después de 5 segundos (excepto errores críticos)
            if (type !== 'error' || message.includes('No se pudo conectar')) {
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }
        
        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
        });
        
        function updateProcesses(processes) {
            const processEl = document.getElementById('process');
            
            // Limpiar empty state si existe
            if (processEl.querySelector('.empty-state')) {
                processEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas
            processEl.innerHTML = '';
            
            processes.forEach(proc => {
                const entry = document.createElement('div');
                entry.className = 'process-entry';
                
                // Determinar nivel de riesgo
                if (proc.cpu > 50 || proc.reason.includes('Comando sospechoso')) {
                    entry.classList.add('critical');
                } else {
                    entry.classList.add('high');
                }
                
                const pidSpan = document.createElement('div');
                pidSpan.className = 'process-pid';
                pidSpan.textContent = `PID: ${proc.pid}`;
                entry.appendChild(pidSpan);
                
                const metricsSpan = document.createElement('div');
                metricsSpan.className = 'process-metrics';
                metricsSpan.textContent = `CPU: ${proc.cpu}% | MEM: ${proc.mem}% | Tiempo: ${proc.time}`;
                entry.appendChild(metricsSpan);
                
                const commandSpan = document.createElement('div');
                commandSpan.className = 'process-command';
                commandSpan.textContent = proc.command;
                entry.appendChild(commandSpan);
                
                const reasonSpan = document.createElement('div');
                reasonSpan.className = 'process-reason';
                reasonSpan.textContent = `⚠️ ${proc.reason}`;
                entry.appendChild(reasonSpan);
                
                processEl.appendChild(entry);
            });
            
            // Actualizar nivel de amenaza si hay procesos sospechosos
            if (processes.length > 0) {
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                showAlert(`🚨 Se detectaron ${processes.length} proceso(s) PHP sospechoso(s)`, 'error');
            }
        }
        
        function updateCrontab(crontabs) {
            const crontabEl = document.getElementById('crontab');
            
            // Limpiar empty state si existe
            if (crontabEl.querySelector('.empty-state')) {
                crontabEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas
            crontabEl.innerHTML = '';
            
            crontabs.forEach(cron => {
                const entry = document.createElement('div');
                entry.className = 'crontab-entry';
                
                const userSpan = document.createElement('div');
                userSpan.className = 'crontab-user';
                userSpan.textContent = `Usuario: ${cron.user}`;
                entry.appendChild(userSpan);
                
                const commandSpan = document.createElement('div');
                commandSpan.className = 'crontab-command';
                commandSpan.textContent = cron.cron;
                entry.appendChild(commandSpan);
                
                crontabEl.appendChild(entry);
            });
            
            // Actualizar nivel de amenaza si hay crontabs sospechosos
            if (crontabs.length > 0) {
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                showAlert(`🚨 Se detectaron ${crontabs.length} tarea(s) sospechosa(s) en crontab`, 'error');
            }
        }
        
        // Manejar cierre de página
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
