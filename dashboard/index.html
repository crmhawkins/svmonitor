<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL HUB - Sistema de Monitoreo</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0d1117; 
            color: #c9d1d9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #30363d;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #58a6ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #da3633;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #3fb950;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        
        .card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            padding: 25px; 
            border-radius: 8px; 
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: #58a6ff;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats { 
            font-size: 2.5rem; 
            color: #58a6ff; 
            font-weight: bold;
        }
        
        .stats.warning {
            color: #ffa657;
        }
        
        .stats.danger {
            color: #da3633;
        }
        
        .panic { 
            background: #da3633; 
            color: white; 
            border: none; 
            padding: 20px; 
            width: 100%; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px;
            font-size: 1.1rem;
            transition: background 0.2s, transform 0.1s;
        }
        
        .panic:hover {
            background: #b62324;
            transform: scale(1.02);
        }
        
        .panic:active {
            transform: scale(0.98);
        }
        
        .panic:disabled {
            background: #30363d;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .console-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .console-container {
                grid-template-columns: 1fr;
            }
        }
        
        .console-wrapper {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        
        .console-wrapper h3 {
            margin-bottom: 10px;
            color: #58a6ff;
            font-size: 1.1rem;
        }
        
        .console { 
            background: #000; 
            color: #39ff14; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 6px; 
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .console::-webkit-scrollbar {
            width: 8px;
        }
        
        .console::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .console::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        
        .console::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        .empty-state {
            color: #484f58;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #161b22;
        }
        
        .alert.error {
            border-color: #da3633;
            color: #f85149;
        }
        
        .alert.warning {
            border-color: #ffa657;
            color: #ffa657;
        }
        
        .alert.info {
            border-color: #58a6ff;
            color: #58a6ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🛰️ SISTEMA SENTINEL</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectando...</span>
        </div>
    </div>
    
    <div id="alertContainer"></div>
    
    <div class="grid">
        <div class="card">
            <div class="card-title">CPU</div>
            <div id="cpu" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Memoria</div>
            <div id="mem" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Nivel de Amenaza</div>
            <div id="threat" class="stats warning">BAJA</div>
        </div>
    </div>
    
    <button class="panic" id="panicBtn" onclick="triggerPanic()">🚨 PROTOCOLO DE PÁNICO</button>
    
    <div class="console-container">
        <div class="console-wrapper">
            <h3>🌐 RED</h3>
            <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
        </div>
        <div class="console-wrapper">
            <h3>📂 ARCHIVOS</h3>
            <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
        </div>
    </div>
    
    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        
        function initSocket() {
            // Conectar solo a localhost
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: Infinity,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('✅ Conectado al servidor');
                updateStatus(true);
                reconnectAttempts = 0;
                showAlert('Conectado al servidor Sentinel', 'info');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('❌ Desconectado:', reason);
                updateStatus(false);
                if (reason === 'io server disconnect') {
                    showAlert('Desconectado por el servidor. Reconectando...', 'warning');
                } else {
                    showAlert('Conexión perdida. Reconectando...', 'warning');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('❌ Error de conexión:', error);
                updateStatus(false);
                reconnectAttempts++;
                if (reconnectAttempts <= maxReconnectAttempts) {
                    showAlert(`Error de conexión (${reconnectAttempts}/${maxReconnectAttempts}). Reintentando...`, 'error');
                } else {
                    showAlert('No se pudo conectar al servidor. Verifica que esté ejecutándose.', 'error');
                }
            });
            
            socket.on('ui_health', (data) => {
                if (data && typeof data === 'object' && data.cpu !== undefined && data.mem !== undefined) {
                    updateHealth(data);
                }
            });
            
            socket.on('ui_network', (data) => {
                if (data && typeof data === 'string') {
                    updateNetwork(data);
                }
            });
            
            socket.on('ui_file', (data) => {
                if (data && typeof data === 'object' && data.detail) {
                    updateFiles(data);
                }
            });
        }
        
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }
        
        function updateHealth(data) {
            const cpuEl = document.getElementById('cpu');
            const memEl = document.getElementById('mem');
            
            const cpu = parseFloat(data.cpu) || 0;
            const mem = parseFloat(data.mem) || 0;
            
            cpuEl.textContent = cpu.toFixed(1) + '%';
            memEl.textContent = mem.toFixed(1) + '%';
            
            // Cambiar color según el uso
            cpuEl.className = 'stats';
            memEl.className = 'stats';
            
            if (cpu > 80) cpuEl.classList.add('danger');
            else if (cpu > 60) cpuEl.classList.add('warning');
            
            if (mem > 80) memEl.classList.add('danger');
            else if (mem > 60) memEl.classList.add('warning');
        }
        
        function updateNetwork(data) {
            const netEl = document.getElementById('net');
            const threatEl = document.getElementById('threat');
            
            // Limpiar empty state si existe
            if (netEl.querySelector('.empty-state')) {
                netEl.innerHTML = '';
            }
            
            // Agregar nueva entrada
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${data}\n`;
            netEl.textContent = entry + netEl.textContent;
            
            // Limitar a 100 líneas
            const lines = netEl.textContent.split('\n');
            if (lines.length > 100) {
                netEl.textContent = lines.slice(0, 100).join('\n');
            }
            
            // Actualizar nivel de amenaza
            const isCritical = data.includes('SYN_SENT') || data.includes('ESTABLISHED');
            threatEl.textContent = isCritical ? 'CRÍTICA' : 'BAJA';
            threatEl.className = 'stats ' + (isCritical ? 'danger' : 'warning');
        }
        
        function updateFiles(data) {
            const fileEl = document.getElementById('file');
            
            // Limpiar empty state si existe
            if (fileEl.querySelector('.empty-state')) {
                fileEl.innerHTML = '';
            }
            
            const timestamp = new Date(data.ts).toLocaleTimeString();
            const entry = `[${timestamp}] ${data.detail}\n`;
            fileEl.textContent = entry + fileEl.textContent;
            
            // Limitar a 100 líneas
            const lines = fileEl.textContent.split('\n');
            if (lines.length > 100) {
                fileEl.textContent = lines.slice(0, 100).join('\n');
            }
        }
        
        function triggerPanic() {
            if (confirm('⚠️ ¿Estás seguro de activar el PROTOCOLO DE PÁNICO?\n\nEsto bloqueará todas las conexiones salientes excepto SSH y localhost.')) {
                if (socket && socket.connected) {
                    socket.emit('panic_action');
                    showAlert('🚨 Protocolo de pánico activado', 'error');
                } else {
                    showAlert('Error: No hay conexión con el servidor', 'error');
                }
            }
        }
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-ocultar después de 5 segundos (excepto errores críticos)
            if (type !== 'error' || message.includes('No se pudo conectar')) {
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }
        
        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
        });
        
        // Manejar cierre de página
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
