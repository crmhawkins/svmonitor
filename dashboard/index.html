<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL HUB - Sistema de Monitoreo</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0d1117; 
            color: #c9d1d9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #30363d;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #58a6ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #da3633;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #3fb950;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        
        .card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            padding: 25px; 
            border-radius: 8px; 
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: #58a6ff;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats { 
            font-size: 2.5rem; 
            color: #58a6ff; 
            font-weight: bold;
        }
        
        .stats.warning {
            color: #ffa657;
        }
        
        .stats.danger {
            color: #da3633;
        }
        
        .panic { 
            background: #da3633; 
            color: white; 
            border: none; 
            padding: 20px; 
            width: 100%; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px;
            font-size: 1.1rem;
            transition: background 0.2s, transform 0.1s;
        }
        
        .panic:hover {
            background: #b62324;
            transform: scale(1.02);
        }
        
        .panic:active {
            transform: scale(0.98);
        }
        
        .panic:disabled {
            background: #30363d;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .console-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .console-container {
                grid-template-columns: 1fr;
            }
        }
        
        .console-wrapper {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        
        .console-wrapper h3 {
            margin-bottom: 10px;
            color: #58a6ff;
            font-size: 1.1rem;
        }
        
        .console { 
            background: #000; 
            color: #39ff14; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 6px; 
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .console::-webkit-scrollbar {
            width: 8px;
        }
        
        .console::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .console::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        
        .console::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        .empty-state {
            color: #484f58;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #161b22;
        }
        
        .alert.error {
            border-color: #da3633;
            color: #f85149;
        }
        
        .alert.warning {
            border-color: #ffa657;
            color: #ffa657;
        }
        
        .alert.info {
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        /* Estilos para entradas de red */
        .network-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .network-entry.safe {
            color: #39ff14;
        }
        
        .network-entry.warning {
            color: #ffa657;
        }
        
        .network-entry.danger {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .network-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .network-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .network-protocol {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .network-state {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin: 0 4px;
        }
        
        .network-state.estab {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .network-state.syn-sent {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        .network-state.listen {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        /* Estilos para archivos según riesgo */
        .file-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .file-entry.low {
            color: #39ff14;
        }
        
        .file-entry.medium {
            color: #ffa657;
        }
        
        .file-entry.high {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .file-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
        }
        
        .file-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .file-path {
            word-break: break-all;
        }
        
        .file-event {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        
        .file-event.modify {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        .file-event.create {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .file-event.delete {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        /* Estilos para procesos */
        .process-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .process-entry.critical {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.15);
        }
        
        .process-entry.high {
            border-color: #f85149;
            background: rgba(248, 81, 73, 0.1);
        }
        
        .process-pid {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .process-metrics {
            color: #8b949e;
            font-size: 0.8rem;
            margin: 4px 0;
        }
        
        .process-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
        
        .process-reason {
            color: #ffa657;
            font-weight: bold;
            margin-top: 4px;
        }
        
        /* Estilos para crontab */
        .crontab-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #f85149;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .crontab-user {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .crontab-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
        
        /* Sistema de pestañas */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #30363d;
            padding-bottom: 0;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #8b949e;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }
        
        .tab:hover {
            color: #c9d1d9;
        }
        
        .tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Sistema de notificaciones toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            background: #161b22;
            border: 1px solid #30363d;
            border-left: 4px solid;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .toast.success {
            border-left-color: #3fb950;
        }
        
        .toast.warning {
            border-left-color: #ffa657;
        }
        
        .toast.error {
            border-left-color: #da3633;
        }
        
        .toast.info {
            border-left-color: #58a6ff;
        }
        
        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #c9d1d9;
        }
        
        .toast-message {
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            color: #c9d1d9;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Sección de sitios web */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .site-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .site-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }
        
        .site-card.active {
            border-left: 4px solid #3fb950;
        }
        
        .site-card.error {
            border-left: 4px solid #ffa657;
        }
        
        .site-card.down {
            border-left: 4px solid #da3633;
        }
        
        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .site-domain {
            font-size: 1.1rem;
            font-weight: bold;
            color: #c9d1d9;
            word-break: break-all;
        }
        
        .site-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .site-status.active {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
        }
        
        .site-status.error {
            background: rgba(255, 166, 87, 0.2);
            color: #ffa657;
        }
        
        .site-status.down {
            background: rgba(218, 54, 51, 0.2);
            color: #da3633;
        }
        
        .site-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .site-info-item {
            display: flex;
            justify-content: space-between;
        }
        
        .site-info-label {
            color: #8b949e;
        }
        
        .site-info-value {
            color: #c9d1d9;
            font-weight: 500;
        }
        
        .sites-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-card.active {
            border-top: 3px solid #3fb950;
        }
        
        .summary-card.error {
            border-top: 3px solid #ffa657;
        }
        
        .summary-card.down {
            border-top: 3px solid #da3633;
        }
        
        .summary-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-card.active .summary-number {
            color: #3fb950;
        }
        
        .summary-card.error .summary-number {
            color: #ffa657;
        }
        
        .summary-card.down .summary-number {
            color: #da3633;
        }
        
        .summary-label {
            color: #8b949e;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🛰️ SISTEMA SENTINEL</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectando...</span>
        </div>
    </div>
    
    <!-- Contenedor de notificaciones toast -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Sistema de pestañas -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('monitoring')">📊 Monitoreo</button>
        <button class="tab" onclick="switchTab('sites')">🌐 Sitios Web</button>
        <button class="tab" onclick="switchTab('security')">🔒 Seguridad</button>
    </div>
    
    <!-- Pestaña: Monitoreo -->
    <div id="tab-monitoring" class="tab-content active">
    <div class="grid">
        <div class="card">
            <div class="card-title">CPU</div>
            <div id="cpu" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Memoria</div>
            <div id="mem" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Nivel de Amenaza</div>
            <div id="threat" class="stats warning">BAJA</div>
        </div>
    </div>
    
    <button class="panic" id="panicBtn" onclick="triggerPanic()">🚨 PROTOCOLO DE PÁNICO</button>
    
    <div class="console-container">
        <div class="console-wrapper">
            <h3>🌐 RED</h3>
            <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
        </div>
        <div class="console-wrapper">
            <h3>📂 ARCHIVOS</h3>
            <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
        </div>
    </div>
    
        <div class="console-container" style="margin-top: 20px;">
            <div class="console-wrapper">
                <h3>⚙️ PROCESOS PHP SOSPECHOSOS</h3>
                <div id="process" class="console"><span class="empty-state">No se detectaron procesos sospechosos...</span></div>
            </div>
            <div class="console-wrapper">
                <h3>⏰ CRONTAB</h3>
                <div id="crontab" class="console"><span class="empty-state">No se detectaron tareas sospechosas...</span></div>
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Sitios Web -->
    <div id="tab-sites" class="tab-content">
        <div class="sites-summary">
            <div class="summary-card active">
                <div class="summary-label">Sitios Activos</div>
                <div class="summary-number" id="sitesActive">0</div>
            </div>
            <div class="summary-card error">
                <div class="summary-label">Sitios con Fallo</div>
                <div class="summary-number" id="sitesError">0</div>
            </div>
            <div class="summary-card down">
                <div class="summary-label">Sitios Caídos</div>
                <div class="summary-number" id="sitesDown">0</div>
            </div>
        </div>
        
        <div class="sites-grid" id="sitesGrid">
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8b949e;">
                🔍 Descubriendo sitios web...
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Seguridad -->
    <div id="tab-security" class="tab-content">
        <div class="console-container">
            <div class="console-wrapper">
                <h3>🌐 RED</h3>
                <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
            </div>
            <div class="console-wrapper">
                <h3>📂 ARCHIVOS</h3>
                <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
            </div>
        </div>
    </div>
    
    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let sitesData = [];
        
        // Sistema de pestañas
        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Sistema de notificaciones toast
        function showToast(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                warning: '⚠️',
                error: '🚨',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-eliminar después de la duración
            if (duration > 0) {
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        function initSocket() {
            // Conectar solo a localhost
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: Infinity,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('✅ Conectado al servidor');
                updateStatus(true);
                reconnectAttempts = 0;
                showToast('Conectado', 'Servidor Sentinel conectado correctamente', 'success');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('❌ Desconectado:', reason);
                updateStatus(false);
                if (reason === 'io server disconnect') {
                    showToast('Desconectado', 'Desconectado por el servidor. Reconectando...', 'warning');
                } else {
                    showToast('Desconectado', 'Conexión perdida. Reconectando...', 'warning');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('❌ Error de conexión:', error);
                updateStatus(false);
                reconnectAttempts++;
                if (reconnectAttempts <= maxReconnectAttempts) {
                    showToast('Error de conexión', `Reintentando (${reconnectAttempts}/${maxReconnectAttempts})...`, 'warning');
                } else {
                    showToast('Error de conexión', 'No se pudo conectar al servidor. Verifica que esté ejecutándose.', 'error', 0);
                }
            });
            
            socket.on('ui_health', (data) => {
                if (data && typeof data === 'object' && data.cpu !== undefined && data.mem !== undefined) {
                    updateHealth(data);
                }
            });
            
            socket.on('ui_network', (data) => {
                if (data && typeof data === 'string') {
                    updateNetwork(data);
                }
            });
            
            socket.on('ui_file', (data) => {
                if (data && typeof data === 'object' && data.detail) {
                    updateFiles(data);
                }
            });
            
            socket.on('ui_process', (data) => {
                if (data && Array.isArray(data)) {
                    updateProcesses(data);
                }
            });
            
            socket.on('ui_crontab', (data) => {
                if (data && Array.isArray(data)) {
                    updateCrontab(data);
                }
            });
            
            socket.on('ui_sites', (data) => {
                if (data && Array.isArray(data)) {
                    updateSites(data);
                }
            });
            
            socket.on('ui_sites_alert', (data) => {
                if (data && typeof data === 'object') {
                    handleSitesAlert(data);
                }
            });
        }
        
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }
        
        function updateHealth(data) {
            const cpuEl = document.getElementById('cpu');
            const memEl = document.getElementById('mem');
            
            const cpu = parseFloat(data.cpu) || 0;
            const mem = parseFloat(data.mem) || 0;
            
            cpuEl.textContent = cpu.toFixed(1) + '%';
            memEl.textContent = mem.toFixed(1) + '%';
            
            // Cambiar color según el uso
            cpuEl.className = 'stats';
            memEl.className = 'stats';
            
            if (cpu > 80) cpuEl.classList.add('danger');
            else if (cpu > 60) cpuEl.classList.add('warning');
            
            if (mem > 80) memEl.classList.add('danger');
            else if (mem > 60) memEl.classList.add('warning');
        }
        
        function updateNetwork(data) {
            const netEl = document.getElementById('net');
            const threatEl = document.getElementById('threat');
            
            // Limpiar empty state si existe
            if (netEl.querySelector('.empty-state')) {
                netEl.innerHTML = '';
            }
            
            // Parsear y formatear las conexiones de red
            const lines = data.split('\n').filter(line => line.trim());
            let hasThreat = false;
            let threatLevel = 'BAJA';
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                const entry = document.createElement('div');
                entry.className = 'network-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'network-timestamp';
                timestampSpan.textContent = `[${timestamp}]`;
                entry.appendChild(timestampSpan);
                
                // Detectar tipo de conexión y nivel de amenaza
                let riskLevel = 'safe';
                let stateClass = '';
                let stateText = '';
                
                if (line.includes('SYN-SENT') || line.includes('SYN_SENT')) {
                    riskLevel = 'critical';
                    hasThreat = true;
                    threatLevel = 'CRÍTICA';
                    stateClass = 'syn-sent';
                    stateText = 'SYN-SENT';
                } else if (line.includes('ESTAB') || line.includes('ESTABLISHED')) {
                    // Verificar si es conexión externa sospechosa
                    const hasExternalIP = /(\d{1,3}\.){3}\d{1,3}/.test(line);
                    const isLocalhost = line.includes('127.0.0.1') || line.includes('::1');
                    
                    if (hasExternalIP && !isLocalhost) {
                        // Verificar si es PHP u otro proceso sospechoso
                        if (line.includes('php') || line.includes('python') || line.includes('perl')) {
                            riskLevel = 'danger';
                            hasThreat = true;
                            if (threatLevel !== 'CRÍTICA') threatLevel = 'ALTA';
                        } else {
                            riskLevel = 'warning';
                            if (threatLevel === 'BAJA') threatLevel = 'MEDIA';
                        }
                    }
                    stateClass = 'estab';
                    stateText = 'ESTAB';
                } else if (line.includes('LISTEN')) {
                    stateClass = 'listen';
                    stateText = 'LISTEN';
                }
                
                entry.classList.add(riskLevel);
                
                // Extraer información de la línea
                const protocolMatch = line.match(/(tcp|udp|tcp6|udp6)/i);
                const protocol = protocolMatch ? protocolMatch[1].toUpperCase() : 'TCP';
                
                const protocolSpan = document.createElement('span');
                protocolSpan.className = 'network-protocol';
                protocolSpan.textContent = protocol;
                entry.appendChild(protocolSpan);
                
                if (stateText) {
                    const stateSpan = document.createElement('span');
                    stateSpan.className = `network-state ${stateClass}`;
                    stateSpan.textContent = stateText;
                    entry.appendChild(stateSpan);
                }
                
                // Agregar información de la conexión
                const infoSpan = document.createElement('span');
                infoSpan.style.marginLeft = '8px';
                infoSpan.style.color = '#c9d1d9';
                
                // Limpiar y formatear la información
                let cleanLine = line.replace(/\s+/g, ' ').trim();
                // Remover información redundante
                cleanLine = cleanLine.replace(/users:\([^)]+\)/g, '').trim();
                infoSpan.textContent = cleanLine;
                entry.appendChild(infoSpan);
                
                // Insertar al principio
                if (netEl.firstChild) {
                    netEl.insertBefore(entry, netEl.firstChild);
                } else {
                    netEl.appendChild(entry);
                }
            });
            
            // Limitar a 50 entradas
            while (netEl.children.length > 50) {
                netEl.removeChild(netEl.lastChild);
            }
            
            // Actualizar nivel de amenaza
            threatEl.textContent = threatLevel;
            if (hasThreat) {
                threatEl.className = 'stats danger';
            } else if (threatLevel === 'MEDIA') {
                threatEl.className = 'stats warning';
            } else {
                threatEl.className = 'stats warning';
            }
        }
        
        function updateFiles(data) {
            const fileEl = document.getElementById('file');
            
            // Limpiar empty state si existe
            if (fileEl.querySelector('.empty-state')) {
                fileEl.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            
            // Determinar nivel de riesgo
            const risk = data.risk || 'low';
            entry.classList.add(risk);
            
            const timestamp = new Date(data.ts).toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'file-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            entry.appendChild(timestampSpan);
            
            // Información del archivo
            const filePath = data.filePath || data.detail.split(' ')[0] || data.detail;
            const events = data.events || (data.detail.includes('MODIFY') ? 'MODIFY' : 
                          data.detail.includes('CREATE') ? 'CREATE' : 
                          data.detail.includes('DELETE') ? 'DELETE' : 'MODIFY');
            
            const pathSpan = document.createElement('span');
            pathSpan.className = 'file-path';
            pathSpan.textContent = filePath;
            entry.appendChild(pathSpan);
            
            // Badge de evento
            const eventSpan = document.createElement('span');
            eventSpan.className = `file-event ${events.toLowerCase()}`;
            eventSpan.textContent = events;
            entry.appendChild(eventSpan);
            
            // Insertar al principio
            if (fileEl.firstChild) {
                fileEl.insertBefore(entry, fileEl.firstChild);
            } else {
                fileEl.appendChild(entry);
            }
            
            // Limitar a 50 entradas
            while (fileEl.children.length > 50) {
                fileEl.removeChild(fileEl.lastChild);
            }
        }
        
        function triggerPanic() {
            if (confirm('⚠️ ¿Estás seguro de activar el PROTOCOLO DE PÁNICO?\n\nEsto bloqueará todas las conexiones salientes excepto SSH y localhost.')) {
                if (socket && socket.connected) {
                    socket.emit('panic_action');
                    showToast('Protocolo de Pánico', 'Protocolo de pánico activado', 'error', 0);
                } else {
                    showToast('Error', 'No hay conexión con el servidor', 'error');
                }
            }
        }
        
        function showAlert(message, type = 'info') {
            // Usar toast en lugar de alert antiguo
            showToast(type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Información', message, type);
        }
        
        function updateSites(sites) {
            sitesData = sites;
            const grid = document.getElementById('sitesGrid');
            
            // Limpiar grid
            grid.innerHTML = '';
            
            if (sites.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8b949e;">🔍 No se encontraron sitios web</div>';
                return;
            }
            
            // Contar por estado
            const active = sites.filter(s => s.status === 'active').length;
            const errors = sites.filter(s => s.status === 'error').length;
            const down = sites.filter(s => s.status === 'down').length;
            
            // Actualizar resumen
            document.getElementById('sitesActive').textContent = active;
            document.getElementById('sitesError').textContent = errors;
            document.getElementById('sitesDown').textContent = down;
            
            // Crear tarjetas de sitios
            sites.forEach(site => {
                const card = document.createElement('div');
                card.className = `site-card ${site.status}`;
                
                const statusText = {
                    'active': 'Activo',
                    'error': 'Error',
                    'down': 'Caído',
                    'unknown': 'Desconocido'
                };
                
                card.innerHTML = `
                    <div class="site-header">
                        <div class="site-domain">${site.domain}</div>
                        <div class="site-status ${site.status}">${statusText[site.status] || 'Desconocido'}</div>
                    </div>
                    <div class="site-info">
                        <div class="site-info-item">
                            <span class="site-info-label">URL:</span>
                            <span class="site-info-value">${site.url}</span>
                        </div>
                        ${site.statusCode ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Código HTTP:</span>
                            <span class="site-info-value">${site.statusCode}</span>
                        </div>
                        ` : ''}
                        ${site.responseTime !== null ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Tiempo de respuesta:</span>
                            <span class="site-info-value">${site.responseTime}ms</span>
                        </div>
                        ` : ''}
                        ${site.lastCheck ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Última verificación:</span>
                            <span class="site-info-value">${new Date(site.lastCheck).toLocaleTimeString()}</span>
                        </div>
                        ` : ''}
                        ${site.error ? `
                        <div class="site-info-item" style="color: #da3633; margin-top: 8px;">
                            <span>⚠️ ${site.error}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function handleSitesAlert(data) {
            const { down, errors } = data;
            
            if (down && down.length > 0) {
                down.forEach(site => {
                    showToast('Sitio Caído', `${site.domain} no está disponible`, 'error', 10000);
                });
            }
            
            if (errors && errors.length > 0) {
                errors.forEach(site => {
                    showToast('Error en Sitio', `${site.domain}: ${site.error || 'Error desconocido'}`, 'warning', 8000);
                });
            }
        }
        
        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
        });
        
        function updateProcesses(processes) {
            const processEl = document.getElementById('process');
            
            // Limpiar empty state si existe
            if (processEl.querySelector('.empty-state')) {
                processEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas
            processEl.innerHTML = '';
            
            processes.forEach(proc => {
                const entry = document.createElement('div');
                entry.className = 'process-entry';
                
                // Determinar nivel de riesgo
                if (proc.cpu > 50 || proc.reason.includes('Comando sospechoso')) {
                    entry.classList.add('critical');
                } else {
                    entry.classList.add('high');
                }
                
                const pidSpan = document.createElement('div');
                pidSpan.className = 'process-pid';
                pidSpan.textContent = `PID: ${proc.pid}`;
                entry.appendChild(pidSpan);
                
                const metricsSpan = document.createElement('div');
                metricsSpan.className = 'process-metrics';
                metricsSpan.textContent = `CPU: ${proc.cpu}% | MEM: ${proc.mem}% | Tiempo: ${proc.time}`;
                entry.appendChild(metricsSpan);
                
                const commandSpan = document.createElement('div');
                commandSpan.className = 'process-command';
                commandSpan.textContent = proc.command;
                entry.appendChild(commandSpan);
                
                const reasonSpan = document.createElement('div');
                reasonSpan.className = 'process-reason';
                reasonSpan.textContent = `⚠️ ${proc.reason}`;
                entry.appendChild(reasonSpan);
                
                processEl.appendChild(entry);
            });
            
            // Actualizar nivel de amenaza si hay procesos sospechosos
            if (processes.length > 0) {
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                showToast('Procesos Sospechosos', `Se detectaron ${processes.length} proceso(s) PHP sospechoso(s)`, 'error');
            }
        }
        
        function updateCrontab(crontabs) {
            const crontabEl = document.getElementById('crontab');
            
            // Limpiar empty state si existe
            if (crontabEl.querySelector('.empty-state')) {
                crontabEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas
            crontabEl.innerHTML = '';
            
            crontabs.forEach(cron => {
                const entry = document.createElement('div');
                entry.className = 'crontab-entry';
                
                const userSpan = document.createElement('div');
                userSpan.className = 'crontab-user';
                userSpan.textContent = `Usuario: ${cron.user}`;
                entry.appendChild(userSpan);
                
                const commandSpan = document.createElement('div');
                commandSpan.className = 'crontab-command';
                commandSpan.textContent = cron.cron;
                entry.appendChild(commandSpan);
                
                crontabEl.appendChild(entry);
            });
            
            // Actualizar nivel de amenaza si hay crontabs sospechosos
            if (crontabs.length > 0) {
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                showToast('Crontab Sospechoso', `Se detectaron ${crontabs.length} tarea(s) sospechosa(s) en crontab`, 'error');
            }
        }
        
        // Manejar cierre de página
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
