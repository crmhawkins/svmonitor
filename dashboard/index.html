<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL HUB - Sistema de Monitoreo</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0d1117; 
            color: #c9d1d9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #30363d;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #58a6ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #da3633;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #3fb950;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        
        .card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            padding: 25px; 
            border-radius: 8px; 
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: #58a6ff;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats { 
            font-size: 2.5rem; 
            color: #58a6ff; 
            font-weight: bold;
        }
        
        .stats.warning {
            color: #ffa657;
        }
        
        .stats.danger {
            color: #da3633;
        }
        
        .panic { 
            background: #da3633; 
            color: white; 
            border: none; 
            padding: 20px; 
            width: 100%; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 20px;
            font-size: 1.1rem;
            transition: background 0.2s, transform 0.1s;
        }
        
        .panic:hover {
            background: #b62324;
            transform: scale(1.02);
        }
        
        .panic:active {
            transform: scale(0.98);
        }
        
        .panic:disabled {
            background: #30363d;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .console-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .console-container {
                grid-template-columns: 1fr;
            }
        }
        
        .console-wrapper {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        
        .console-wrapper h3 {
            margin-bottom: 10px;
            color: #58a6ff;
            font-size: 1.1rem;
        }
        
        .console { 
            background: #000; 
            color: #39ff14; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 6px; 
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .console::-webkit-scrollbar {
            width: 8px;
        }
        
        .console::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .console::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        
        .console::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        .empty-state {
            color: #484f58;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #161b22;
        }
        
        .alert.error {
            border-color: #da3633;
            color: #f85149;
        }
        
        .alert.warning {
            border-color: #ffa657;
            color: #ffa657;
        }
        
        .alert.info {
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        /* Estilos para entradas de red */
        .network-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .network-entry.safe {
            color: #39ff14;
        }
        
        .network-entry.warning {
            color: #ffa657;
        }
        
        .network-entry.danger {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .network-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .network-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .network-protocol {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .network-state {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin: 0 4px;
        }
        
        .network-state.estab {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .network-state.syn-sent {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        .network-state.listen {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        /* Estilos para archivos según riesgo */
        .file-entry {
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .file-entry.low {
            color: #39ff14;
        }
        
        .file-entry.medium {
            color: #ffa657;
        }
        
        .file-entry.high {
            color: #f85149;
            background: rgba(218, 54, 51, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .file-entry.critical {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
            font-weight: bold;
        }
        
        .file-timestamp {
            color: #8b949e;
            margin-right: 8px;
        }
        
        .file-path {
            word-break: break-all;
        }
        
        .file-event {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        
        .file-event.modify {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        .file-event.create {
            background: rgba(57, 255, 20, 0.2);
            color: #39ff14;
        }
        
        .file-event.delete {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            font-weight: bold;
        }
        
        /* Estilos para procesos */
        .process-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .process-entry.critical {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.15);
        }
        
        .process-entry.high {
            border-color: #f85149;
            background: rgba(248, 81, 73, 0.1);
        }
        
        .process-pid {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .process-metrics {
            color: #8b949e;
            font-size: 0.8rem;
            margin: 4px 0;
        }
        
        .process-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
        
        .process-reason {
            color: #ffa657;
            font-weight: bold;
            margin-top: 4px;
        }
        
        /* Estilos para crontab */
        .crontab-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #f85149;
            background: rgba(218, 54, 51, 0.1);
            font-size: 0.85rem;
        }
        
        .crontab-user {
            color: #58a6ff;
            font-weight: bold;
        }
        
        .crontab-command {
            color: #c9d1d9;
            word-break: break-all;
            margin-top: 4px;
        }
        
        /* Sistema de pestañas */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #30363d;
            padding-bottom: 0;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #8b949e;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }
        
        .tab:hover {
            color: #c9d1d9;
        }
        
        .tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Sistema de notificaciones toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            background: #161b22;
            border: 1px solid #30363d;
            border-left: 4px solid;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .toast.success {
            border-left-color: #3fb950;
        }
        
        .toast.warning {
            border-left-color: #ffa657;
        }
        
        .toast.error {
            border-left-color: #da3633;
        }
        
        .toast.info {
            border-left-color: #58a6ff;
        }
        
        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #c9d1d9;
        }
        
        .toast-message {
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            color: #c9d1d9;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Sección de sitios web */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .site-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .site-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }
        
        .site-card.active {
            border-left: 4px solid #3fb950;
        }
        
        .site-card.error {
            border-left: 4px solid #ffa657;
        }
        
        .site-card.down {
            border-left: 4px solid #da3633;
        }
        
        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .site-domain {
            font-size: 1.1rem;
            font-weight: bold;
            color: #c9d1d9;
            word-break: break-all;
        }
        
        .site-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .site-status.active {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
        }
        
        .site-status.error {
            background: rgba(255, 166, 87, 0.2);
            color: #ffa657;
        }
        
        .site-status.down {
            background: rgba(218, 54, 51, 0.2);
            color: #da3633;
        }
        
        .site-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .site-info-item {
            display: flex;
            justify-content: space-between;
        }
        
        .site-info-label {
            color: #8b949e;
        }
        
        .site-info-value {
            color: #c9d1d9;
            font-weight: 500;
        }
        
        .sites-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-card.active {
            border-top: 3px solid #3fb950;
        }
        
        .summary-card.error {
            border-top: 3px solid #ffa657;
        }
        
        .summary-card.down {
            border-top: 3px solid #da3633;
        }
        
        .summary-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-card.active .summary-number {
            color: #3fb950;
        }
        
        .summary-card.error .summary-number {
            color: #ffa657;
        }
        
        .summary-card.down .summary-number {
            color: #da3633;
        }
        
        .summary-label {
            color: #8b949e;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🛰️ SISTEMA SENTINEL</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectando...</span>
        </div>
    </div>
    
    <!-- Contenedor de notificaciones toast -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Sistema de pestañas -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('monitoring')">📊 Monitoreo</button>
        <button class="tab" onclick="switchTab('sites')">🌐 Sitios Web</button>
        <button class="tab" onclick="switchTab('security')">🔒 Seguridad</button>
        <button class="tab" onclick="switchTab('ai')">🤖 Análisis de IA</button>
        <button class="tab" onclick="switchTab('soc')">🛡️ Automatización SOC</button>
    </div>
    
    <!-- Pestaña: Monitoreo -->
    <div id="tab-monitoring" class="tab-content active">
    <div class="grid">
        <div class="card">
            <div class="card-title">CPU</div>
            <div id="cpu" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Memoria</div>
            <div id="mem" class="stats">0%</div>
        </div>
        <div class="card">
            <div class="card-title">Nivel de Amenaza</div>
            <div id="threat" class="stats warning">BAJA</div>
        </div>
    </div>
    
    <button class="panic" id="panicBtn" onclick="triggerPanic()">🚨 PROTOCOLO DE PÁNICO</button>
    
    <div class="console-container">
        <div class="console-wrapper">
            <h3>🌐 RED</h3>
            <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
        </div>
        <div class="console-wrapper">
            <h3>📂 ARCHIVOS</h3>
            <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
        </div>
    </div>
    
        <div class="console-container" style="margin-top: 20px;">
            <div class="console-wrapper">
                <h3>⚙️ PROCESOS PHP SOSPECHOSOS</h3>
                <div id="process" class="console"><span class="empty-state">No se detectaron procesos sospechosos...</span></div>
            </div>
            <div class="console-wrapper">
                <h3>⏰ CRONTAB</h3>
                <div id="crontab" class="console"><span class="empty-state">No se detectaron tareas sospechosas...</span></div>
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Sitios Web -->
    <div id="tab-sites" class="tab-content">
        <div class="sites-summary">
            <div class="summary-card active">
                <div class="summary-label">Sitios Activos</div>
                <div class="summary-number" id="sitesActive">0</div>
            </div>
            <div class="summary-card error">
                <div class="summary-label">Sitios con Fallo</div>
                <div class="summary-number" id="sitesError">0</div>
            </div>
            <div class="summary-card down">
                <div class="summary-label">Sitios Caídos</div>
                <div class="summary-number" id="sitesDown">0</div>
            </div>
        </div>
        
        <div class="sites-grid" id="sitesGrid">
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8b949e;">
                🔍 Descubriendo sitios web...
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Seguridad -->
    <div id="tab-security" class="tab-content">
        <div class="console-container">
            <div class="console-wrapper">
                <h3>🌐 RED</h3>
                <pre id="net" class="console"><span class="empty-state">Esperando datos de red...</span></pre>
            </div>
            <div class="console-wrapper">
                <h3>📂 ARCHIVOS</h3>
                <pre id="file" class="console"><span class="empty-state">Esperando cambios de archivos...</span></pre>
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Análisis de IA -->
    <div id="tab-ai" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; color: #8b949e;">Modelo de IA:</label>
                <select id="aiModel" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                    <option value="mistral">Mistral (Recomendado para seguridad)</option>
                    <option value="llama3.2">Llama 3.2</option>
                    <option value="deepseek-r1">DeepSeek R1</option>
                    <option value="qwen2.5">Qwen 2.5</option>
                </select>
            </div>
            <div>
                <button onclick="generateAIAnalysis()" style="width: 100%; padding: 12px; background: #58a6ff; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 28px;">
                    🔍 Generar Análisis Completo
                </button>
            </div>
        </div>
        
        <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #58a6ff;">💬 Conversación con IA</h3>
            <div id="aiChat" style="height: 400px; overflow-y: auto; background: #0d1117; padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.6;">
                <div class="ai-message" style="padding: 10px; margin-bottom: 10px; background: rgba(88, 166, 255, 0.1); border-left: 3px solid #58a6ff; border-radius: 4px;">
                    <strong style="color: #58a6ff;">🤖 Asistente:</strong>
                    <div style="margin-top: 5px; color: #c9d1d9;">
                        Hola, soy tu asistente de análisis de seguridad. Puedo ayudarte a:
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Analizar amenazas detectadas en tu sistema</li>
                            <li>Generar instrucciones de reconocimiento y mitigación</li>
                            <li>Responder preguntas sobre seguridad</li>
                        </ul>
                        Haz clic en "Generar Análisis Completo" para que analice todos los datos del sistema, o escribe una pregunta específica.
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <input type="text" id="aiInput" placeholder="Escribe tu pregunta o solicita un análisis..." 
                       style="flex: 1; padding: 12px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;"
                       onkeypress="if(event.key === 'Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" style="padding: 12px 24px; background: #3fb950; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    Enviar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Pestaña: Automatización SOC -->
    <div id="tab-soc" class="tab-content">
        <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #58a6ff;">🛡️ Sistema de Investigación Automática SOC</h3>
            <p style="color: #8b949e; margin-bottom: 15px;">
                El sistema investiga automáticamente cuando se detectan múltiples eventos sospechosos. 
                La IA genera comandos de investigación y analiza los hallazgos sin tomar acciones destructivas.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <div style="background: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                    <div style="color: #8b949e; font-size: 0.9rem;">Investigaciones Totales</div>
                    <div id="socTotalInvestigations" style="font-size: 2rem; color: #58a6ff; font-weight: bold;">0</div>
                </div>
                <div style="background: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                    <div style="color: #8b949e; font-size: 0.9rem;">En Progreso</div>
                    <div id="socInProgress" style="font-size: 2rem; color: #ffa657; font-weight: bold;">0</div>
                </div>
                <div style="background: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                    <div style="color: #8b949e; font-size: 0.9rem;">Archivos en Cuarentena</div>
                    <div id="socQuarantined" style="font-size: 2rem; color: #da3633; font-weight: bold;">0</div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px;">
                <h3 style="margin-bottom: 15px; color: #58a6ff;">📋 Investigaciones</h3>
                <div id="socInvestigations" style="max-height: 600px; overflow-y: auto;">
                    <div class="empty-state" style="text-align: center; padding: 40px; color: #8b949e;">
                        No hay investigaciones aún...
                    </div>
                </div>
            </div>
            
            <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px;">
                <h3 style="margin-bottom: 15px; color: #58a6ff;">🔒 Archivos en Cuarentena</h3>
                <div id="socQuarantineList" style="max-height: 600px; overflow-y: auto;">
                    <div class="empty-state" style="text-align: center; padding: 40px; color: #8b949e;">
                        No hay archivos en cuarentena...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // El servidor ya maneja la autenticación, no necesitamos verificar aquí
        // para evitar bucles de redirección
        
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let sitesData = [];
        
        // Sistema de pestañas
        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Sistema de notificaciones toast
        function showToast(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                warning: '⚠️',
                error: '🚨',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-eliminar después de la duración
            if (duration > 0) {
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        function initSocket() {
            // Conectar solo a localhost
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: Infinity,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('✅ Conectado al servidor');
                updateStatus(true);
                reconnectAttempts = 0;
                showToast('Conectado', 'Servidor Sentinel conectado correctamente', 'success');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('❌ Desconectado:', reason);
                updateStatus(false);
                if (reason === 'io server disconnect') {
                    showToast('Desconectado', 'Desconectado por el servidor. Reconectando...', 'warning');
                } else {
                    showToast('Desconectado', 'Conexión perdida. Reconectando...', 'warning');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('❌ Error de conexión:', error);
                updateStatus(false);
                reconnectAttempts++;
                if (reconnectAttempts <= maxReconnectAttempts) {
                    showToast('Error de conexión', `Reintentando (${reconnectAttempts}/${maxReconnectAttempts})...`, 'warning');
                } else {
                    showToast('Error de conexión', 'No se pudo conectar al servidor. Verifica que esté ejecutándose.', 'error', 0);
                }
            });
            
            socket.on('ui_health', (data) => {
                if (data && typeof data === 'object' && data.cpu !== undefined && data.mem !== undefined) {
                    updateHealth(data);
                }
            });
            
            socket.on('ui_network', (data) => {
                if (data && typeof data === 'string') {
                    updateNetwork(data);
                }
            });
            
            socket.on('ui_file', (data) => {
                if (data && typeof data === 'object' && data.detail) {
                    updateFiles(data);
                }
            });
            
            socket.on('ui_process', (data) => {
                if (data && Array.isArray(data)) {
                    updateProcesses(data);
                }
            });
            
            socket.on('ui_crontab', (data) => {
                if (data && Array.isArray(data)) {
                    updateCrontab(data);
                }
            });
            
            socket.on('ui_sites', (data) => {
                if (data && Array.isArray(data)) {
                    updateSites(data);
                }
            });
            
            socket.on('ui_sites_alert', (data) => {
                if (data && typeof data === 'object') {
                    handleSitesAlert(data);
                }
            });
            
            // Recibir historial completo cuando se conecta
            socket.on('log_history', (data) => {
                if (data) {
                    loadLogHistory(data);
                }
            });
            
            // Recibir actualizaciones de investigaciones SOC
            socket.on('soc_investigation_update', (data) => {
                if (data) {
                    updateSOCInvestigation(data);
                }
            });
        }
        
        // Cargar investigaciones SOC al iniciar
        async function loadSOCInvestigations() {
            try {
                const response = await fetch('/api/soc/investigations');
                if (response.ok) {
                    const investigations = await response.json();
                    investigations.forEach(inv => updateSOCInvestigation(inv));
                }
            } catch (error) {
                console.error('Error cargando investigaciones SOC:', error);
            }
            
            // Cargar archivos en cuarentena
            loadQuarantineFiles();
        }
        
        // Actualizar investigación SOC
        let socUpdateThrottle = {};
        function updateSOCInvestigation(investigation) {
            const container = document.getElementById('socInvestigations');
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }
            
            let investigationEl = document.getElementById(`soc-inv-${investigation.id}`);
            const isNew = !investigationEl;
            
            if (!investigationEl) {
                investigationEl = document.createElement('div');
                investigationEl.id = `soc-inv-${investigation.id}`;
                investigationEl.style.cssText = 'background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 15px; margin-bottom: 15px;';
                container.insertBefore(investigationEl, container.firstChild);
            }
            
            // Throttle: solo actualizar cada 2 segundos si no es nueva y está ejecutando
            if (!isNew && investigation.status === 'executing') {
                const now = Date.now();
                const lastUpdate = socUpdateThrottle[investigation.id] || 0;
                if (now - lastUpdate < 2000) {
                    return; // Saltar actualización si fue hace menos de 2 segundos
                }
                socUpdateThrottle[investigation.id] = now;
            } else if (investigation.status === 'completed' || investigation.status === 'error') {
                // Si está completada, actualizar siempre
                delete socUpdateThrottle[investigation.id];
            }
            
            const statusColors = {
                'investigating': '#ffa657',
                'commands_generated': '#58a6ff',
                'executing': '#58a6ff',
                'completed': '#3fb950',
                'error': '#da3633'
            };
            
            const statusTexts = {
                'investigating': '🔍 Generando comandos...',
                'commands_generated': '📝 Comandos generados',
                'executing': '⚙️ Ejecutando comandos',
                'completed': '✅ Completada',
                'error': '❌ Error'
            };
            
            // Calcular progreso
            const totalCommands = investigation.totalCommands || investigation.commands?.length || 0;
            const currentIndex = investigation.currentCommandIndex || 0;
            const progressPercent = totalCommands > 0 ? Math.round((currentIndex / totalCommands) * 100) : 0;
            
            investigationEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong style="color: #58a6ff;">${investigation.id}</strong>
                        <div style="color: #8b949e; font-size: 0.85rem; margin-top: 4px;">
                            ${new Date(investigation.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div style="color: ${statusColors[investigation.status] || '#8b949e'}; font-weight: bold;">
                        ${statusTexts[investigation.status] || investigation.status}
                    </div>
                </div>
                
                ${investigation.status === 'executing' && investigation.currentCommand ? `
                    <div style="margin-top: 15px; padding: 15px; background: #161b22; border: 1px solid #58a6ff; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="color: #58a6ff; font-weight: bold;">
                                ⚙️ Ejecutando comando ${currentIndex} de ${totalCommands}
                            </div>
                            <div style="color: #8b949e; font-size: 0.85rem;">
                                ${progressPercent}%
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-family: monospace; font-size: 0.85rem; color: #c9d1d9;">
                            <div style="color: #58a6ff; margin-bottom: 5px;">$ ${investigation.currentCommand}</div>
                            <div style="color: ${investigation.currentCommandStatus === 'error' ? '#da3633' : '#8b949e'}; margin-top: 5px;">
                                Estado: ${investigation.currentCommandStatus === 'ejecutando' ? '🔄 Ejecutando...' : 
                                         investigation.currentCommandStatus === 'completado' ? '✅ Completado' : 
                                         investigation.currentCommandStatus === 'error' ? '❌ Error' : '⏳ Pendiente'}
                            </div>
                        </div>
                        ${investigation.currentCommandOutput ? `
                            <details open style="margin-top: 10px;">
                                <summary style="color: #58a6ff; cursor: pointer; font-weight: bold; margin-bottom: 5px;">Salida en tiempo real</summary>
                                <div style="background: #0d1117; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; max-height: 200px; overflow-y: auto; color: #c9d1d9; white-space: pre-wrap; word-break: break-all;">
                                    ${investigation.currentCommandOutput}
                                </div>
                            </details>
                        ` : ''}
                        <div style="margin-top: 10px; background: #0d1117; height: 4px; border-radius: 2px; overflow: hidden;">
                            <div style="background: #58a6ff; height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                ` : ''}
                
                ${investigation.commands && investigation.commands.length > 0 ? `
                    <div style="margin-top: 10px;">
                        <div style="color: #8b949e; font-size: 0.9rem; margin-bottom: 5px;">
                            Comandos generados: ${investigation.commands.length}
                            ${investigation.status === 'completed' ? ' - Todos ejecutados' : ''}
                        </div>
                        <div style="background: #161b22; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 150px; overflow-y: auto;">
                            ${investigation.commands.slice(0, 5).map((cmd, idx) => {
                                const cmdResult = investigation.commandProgress?.find(c => c.index === idx + 1);
                                const statusIcon = cmdResult ? 
                                    (cmdResult.status === 'completado' ? '✅' : cmdResult.status === 'error' ? '❌' : '⏳') : 
                                    (idx < currentIndex ? '✅' : idx === currentIndex - 1 ? '🔄' : '⏳');
                                return `<div style="color: ${cmdResult?.status === 'error' ? '#da3633' : cmdResult?.status === 'completado' ? '#3fb950' : '#c9d1d9'}; margin-bottom: 3px;">
                                    ${statusIcon} $ ${cmd}
                                </div>`;
                            }).join('')}
                            ${investigation.commands.length > 5 ? `<div style="color: #8b949e;">... y ${investigation.commands.length - 5} más</div>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${investigation.commandProgress && investigation.commandProgress.length > 0 ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: #58a6ff; cursor: pointer; font-weight: bold;">Ver resultados de comandos (${investigation.commandProgress.length})</summary>
                        <div style="margin-top: 10px; max-height: 400px; overflow-y: auto;">
                            ${investigation.commandProgress.map(cmd => `
                                <div style="background: #161b22; padding: 10px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid ${cmd.status === 'completado' ? '#3fb950' : cmd.status === 'error' ? '#da3633' : '#58a6ff'};">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 5px; font-family: monospace; font-size: 0.85rem;">
                                        $ ${cmd.command}
                                    </div>
                                    <div style="color: #8b949e; font-size: 0.8rem; margin-bottom: 5px;">
                                        Estado: ${cmd.status === 'completado' ? '✅ Completado' : cmd.status === 'error' ? '❌ Error' : '⏳ Pendiente'} 
                                        ${cmd.exitCode !== undefined ? `(Código: ${cmd.exitCode})` : ''}
                                    </div>
                                    ${cmd.output ? `
                                        <details style="margin-top: 5px;">
                                            <summary style="color: #8b949e; cursor: pointer; font-size: 0.85rem;">Ver salida</summary>
                                            <div style="background: #0d1117; padding: 8px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 0.75rem; color: #c9d1d9; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">
                                                ${cmd.output.substring(0, 5000)}${cmd.output.length > 5000 ? '\n... (truncado)' : ''}
                                            </div>
                                        </details>
                                    ` : ''}
                                    ${cmd.error ? `
                                        <div style="background: rgba(218, 54, 51, 0.1); padding: 8px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 0.75rem; color: #f85149; white-space: pre-wrap;">
                                            ${cmd.error}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </details>
                ` : ''}
                
                ${investigation.quarantined && investigation.quarantined.length > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(218, 54, 51, 0.1); border: 1px solid #da3633; border-radius: 4px;">
                        <div style="color: #da3633; font-weight: bold; margin-bottom: 5px;">🔒 ${investigation.quarantined.length} archivo(s) en cuarentena</div>
                        <div style="font-size: 0.85rem; color: #8b949e;">
                            ${investigation.quarantined.slice(0, 3).map(q => `<div>• ${q.original}</div>`).join('')}
                            ${investigation.quarantined.length > 3 ? `<div>... y ${investigation.quarantined.length - 3} más</div>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${investigation.report ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: #58a6ff; cursor: pointer; font-weight: bold;">📄 Ver Reporte Completo</summary>
                        <div style="background: #161b22; padding: 15px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; font-size: 0.85rem; line-height: 1.6; max-height: 400px; overflow-y: auto; color: #c9d1d9;">
                            ${investigation.report}
                        </div>
                    </details>
                ` : ''}
                
                ${investigation.logs && investigation.logs.length > 0 ? `
                    <details style="margin-top: 10px;">
                        <summary style="color: #ffa657; cursor: pointer; font-weight: bold; font-size: 1rem;">
                            📋 Ver Logs Detallados (${investigation.logs.length} entradas)
                        </summary>
                        <div style="background: #161b22; padding: 15px; border-radius: 4px; margin-top: 10px; max-height: 600px; overflow-y: auto;">
                            ${investigation.logs.map((log, idx) => {
                                const logTime = new Date(log.timestamp).toLocaleTimeString();
                                const logColors = {
                                    'info': '#58a6ff',
                                    'analyze': '#ffa657',
                                    'ai_request': '#9b59b6',
                                    'ai_response': '#9b59b6',
                                    'command': '#3fb950',
                                    'read': '#58a6ff',
                                    'modify': '#ffa657',
                                    'quarantine': '#da3633',
                                    'error': '#da3633'
                                };
                                const logIcons = {
                                    'info': 'ℹ️',
                                    'analyze': '🔍',
                                    'ai_request': '🤖',
                                    'ai_response': '🤖',
                                    'command': '⚙️',
                                    'read': '📖',
                                    'modify': '✏️',
                                    'quarantine': '🔒',
                                    'error': '❌'
                                };
                                const logColor = logColors[log.type] || '#8b949e';
                                const logIcon = logIcons[log.type] || '•';
                                
                                return `
                                    <div style="background: #0d1117; padding: 12px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${logColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                            <div style="color: ${logColor}; font-weight: bold; font-size: 0.9rem;">
                                                ${logIcon} ${log.message}
                                            </div>
                                            <div style="color: #8b949e; font-size: 0.75rem; margin-left: 10px;">
                                                ${logTime}
                                            </div>
                                        </div>
                                        ${log.data ? `
                                            <details style="margin-top: 5px;">
                                                <summary style="color: #8b949e; cursor: pointer; font-size: 0.8rem;">Ver detalles</summary>
                                                <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 0.75rem; color: #c9d1d9; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">
                                                    ${JSON.stringify(log.data, null, 2)}
                                                </div>
                                            </details>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </details>
                ` : ''}
            `;
            
            // Actualizar estadísticas
            updateSOCStats();
            
            // Auto-scroll solo si es nueva investigación o está completada (para ver el reporte)
            if (isNew || investigation.status === 'completed') {
                investigationEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Si está completada y tiene reporte, expandir automáticamente el reporte
            if (investigation.status === 'completed' && investigation.report) {
                const reportDetails = investigationEl.querySelector('details');
                if (reportDetails && !reportDetails.open) {
                    reportDetails.open = true;
                }
            }
        }
        
        // Actualizar estadísticas SOC
        function updateSOCStats() {
            const investigations = Array.from(document.querySelectorAll('[id^="soc-inv-"]'));
            const total = investigations.length;
            const inProgress = investigations.filter(el => {
                const status = el.textContent;
                return status.includes('Investigando') || status.includes('Ejecutando') || status.includes('generados');
            }).length;
            
            document.getElementById('socTotalInvestigations').textContent = total;
            document.getElementById('socInProgress').textContent = inProgress;
        }
        
        // Cargar archivos en cuarentena
        async function loadQuarantineFiles() {
            try {
                const response = await fetch('/api/soc/quarantine');
                if (response.ok) {
                    const files = await response.json();
                    const container = document.getElementById('socQuarantineList');
                    
                    if (container.querySelector('.empty-state')) {
                        container.innerHTML = '';
                    }
                    
                    if (files.length === 0) {
                        container.innerHTML = '<div class="empty-state" style="text-align: center; padding: 40px; color: #8b949e;">No hay archivos en cuarentena...</div>';
                    } else {
                        container.innerHTML = files.map(file => `
                            <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                                <div style="color: #c9d1d9; font-weight: bold; margin-bottom: 5px;">${file.name}</div>
                                <div style="color: #8b949e; font-size: 0.85rem; margin-bottom: 10px;">
                                    Tamaño: ${(file.size / 1024).toFixed(2)} KB<br>
                                    Creado: ${new Date(file.created).toLocaleString()}
                                </div>
                                <a href="${file.path}" download style="display: inline-block; padding: 6px 12px; background: #58a6ff; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">
                                    ⬇️ Descargar
                                </a>
                            </div>
                        `).join('');
                    }
                    
                    document.getElementById('socQuarantined').textContent = files.length;
                }
            } catch (error) {
                console.error('Error cargando archivos en cuarentena:', error);
            }
        }
        
        // Cargar investigaciones al iniciar
        loadSOCInvestigations();
        
        // Cargar historial de logs persistente
        function loadLogHistory(history) {
            // Cargar historial de red
            if (history.network && history.network.length > 0) {
                const netEl = document.getElementById('net');
                // Limpiar solo el empty state
                if (netEl.querySelector('.empty-state')) {
                    netEl.innerHTML = '';
                }
                
                // Ordenar por timestamp (más reciente primero) y cargar
                const sortedNetwork = history.network.sort((a, b) => b.timestamp - a.timestamp);
                
                // Actualizar systemData con historial de red
                systemData.network = [];
                sortedNetwork.forEach(item => {
                    const lines = (item.data || '').split('\n').filter(l => l.trim());
                    lines.forEach(line => {
                        if (line.trim()) {
                            createNetworkEntry(line, netEl);
                            const risk = line.includes('SYN-SENT') || line.includes('SYN_SENT') ? 'critical' :
                                       (line.includes('php') || line.includes('python') || line.includes('perl')) && 
                                       /(\d{1,3}\.){3}\d{1,3}/.test(line) && !line.includes('127.0.0.1') ? 'high' : 'medium';
                            systemData.network.push({
                                detail: line,
                                risk: risk,
                                timestamp: item.timestamp || Date.now()
                            });
                        }
                    });
                });
                if (systemData.network.length > 50) systemData.network = systemData.network.slice(0, 50);
            }
            
            // Cargar historial de archivos
            if (history.files && history.files.length > 0) {
                const fileEl = document.getElementById('file');
                // Limpiar solo el empty state
                if (fileEl.querySelector('.empty-state')) {
                    fileEl.innerHTML = '';
                }
                
                // Ordenar por timestamp (más reciente primero) y cargar
                const sortedFiles = history.files.sort((a, b) => b.timestamp - a.timestamp);
                
                // Actualizar systemData con historial de archivos
                systemData.files = sortedFiles.slice(0, 50);
                
                sortedFiles.slice(0, 50).forEach(file => {
                    createFileEntry(file, fileEl);
                });
            }
            
            // Cargar historial de procesos
            if (history.processes && history.processes.length > 0) {
                const processEl = document.getElementById('process');
                if (processEl.querySelector('.empty-state')) {
                    processEl.innerHTML = '';
                }
                
                // Agrupar procesos por timestamp similar (misma verificación)
                const processGroups = {};
                history.processes.forEach(proc => {
                    const key = Math.floor(proc.timestamp / 5000) * 5000; // Agrupar por ventana de 5 segundos
                    if (!processGroups[key]) {
                        processGroups[key] = [];
                    }
                    processGroups[key].push(proc);
                });
                
                // Mostrar el grupo más reciente
                const latestGroup = Object.keys(processGroups).sort((a, b) => b - a)[0];
                if (latestGroup) {
                    processEl.innerHTML = '';
                    // Actualizar systemData con el grupo más reciente
                    systemData.processes = processGroups[latestGroup];
                    processGroups[latestGroup].forEach(proc => {
                        createProcessEntry(proc, processEl);
                    });
                }
            }
            
            // Cargar historial de crontab
            if (history.crontab && history.crontab.length > 0) {
                const crontabEl = document.getElementById('crontab');
                if (crontabEl.querySelector('.empty-state')) {
                    crontabEl.innerHTML = '';
                }
                
                // Agrupar crontab por timestamp similar
                const crontabGroups = {};
                history.crontab.forEach(cron => {
                    const key = Math.floor(cron.timestamp / 60000) * 60000; // Agrupar por minuto
                    if (!crontabGroups[key]) {
                        crontabGroups[key] = [];
                    }
                    crontabGroups[key].push(cron);
                });
                
                // Mostrar el grupo más reciente
                const latestGroup = Object.keys(crontabGroups).sort((a, b) => b - a)[0];
                if (latestGroup) {
                    crontabEl.innerHTML = '';
                    // Actualizar systemData con el grupo más reciente
                    systemData.crontab = crontabGroups[latestGroup];
                    crontabGroups[latestGroup].forEach(cron => {
                        createCrontabEntry(cron, crontabEl);
                    });
                }
            }
        }
        
        // Funciones auxiliares para crear entradas sin duplicar
        function createNetworkEntry(line, container) {
            const entry = document.createElement('div');
            entry.className = 'network-entry';
            
            // Detectar tipo de conexión y nivel de amenaza
            let riskLevel = 'safe';
            let stateClass = '';
            let stateText = '';
            
            if (line.includes('SYN-SENT') || line.includes('SYN_SENT')) {
                riskLevel = 'critical';
                stateClass = 'syn-sent';
                stateText = 'SYN-SENT';
            } else if (line.includes('ESTAB') || line.includes('ESTABLISHED')) {
                const hasExternalIP = /(\d{1,3}\.){3}\d{1,3}/.test(line);
                const isLocalhost = line.includes('127.0.0.1') || line.includes('::1');
                
                if (hasExternalIP && !isLocalhost) {
                    if (line.includes('php') || line.includes('python') || line.includes('perl')) {
                        riskLevel = 'danger';
                    } else {
                        riskLevel = 'warning';
                    }
                }
                stateClass = 'estab';
                stateText = 'ESTAB';
            } else if (line.includes('LISTEN')) {
                stateClass = 'listen';
                stateText = 'LISTEN';
            }
            
            entry.classList.add(riskLevel);
            
            const protocolMatch = line.match(/(tcp|udp|tcp6|udp6)/i);
            const protocol = protocolMatch ? protocolMatch[1].toUpperCase() : 'TCP';
            
            const timestamp = new Date().toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'network-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            entry.appendChild(timestampSpan);
            
            const protocolSpan = document.createElement('span');
            protocolSpan.className = 'network-protocol';
            protocolSpan.textContent = protocol;
            entry.appendChild(protocolSpan);
            
            if (stateText) {
                const stateSpan = document.createElement('span');
                stateSpan.className = `network-state ${stateClass}`;
                stateSpan.textContent = stateText;
                entry.appendChild(stateSpan);
            }
            
            const infoSpan = document.createElement('span');
            infoSpan.style.marginLeft = '8px';
            infoSpan.style.color = '#c9d1d9';
            let cleanLine = line.replace(/\s+/g, ' ').trim();
            cleanLine = cleanLine.replace(/users:\([^)]+\)/g, '').trim();
            infoSpan.textContent = cleanLine;
            entry.appendChild(infoSpan);
            
            if (container.firstChild) {
                container.insertBefore(entry, container.firstChild);
            } else {
                container.appendChild(entry);
            }
        }
        
        function createFileEntry(file, container) {
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            
            const risk = file.risk || 'low';
            entry.classList.add(risk);
            
            const timestamp = new Date(file.ts || file.timestamp).toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'file-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            entry.appendChild(timestampSpan);
            
            const filePath = file.filePath || file.detail.split(' ')[0] || file.detail;
            const events = file.events || (file.detail.includes('MODIFY') ? 'MODIFY' : 
                          file.detail.includes('CREATE') ? 'CREATE' : 
                          file.detail.includes('DELETE') ? 'DELETE' : 'MODIFY');
            
            const pathSpan = document.createElement('span');
            pathSpan.className = 'file-path';
            pathSpan.textContent = filePath;
            entry.appendChild(pathSpan);
            
            const eventSpan = document.createElement('span');
            eventSpan.className = `file-event ${events.toLowerCase()}`;
            eventSpan.textContent = events;
            entry.appendChild(eventSpan);
            
            if (file.process && file.process.pid) {
                const processSpan = document.createElement('div');
                processSpan.style.cssText = 'margin-top: 4px; font-size: 0.8rem; color: #8b949e;';
                processSpan.innerHTML = `🔧 Proceso: <strong style="color: #58a6ff;">${file.process.command}</strong> (PID: ${file.process.pid}, Usuario: ${file.process.user})`;
                entry.appendChild(processSpan);
            }
            
            if (container.firstChild) {
                container.insertBefore(entry, container.firstChild);
            } else {
                container.appendChild(entry);
            }
        }
        
        function createProcessEntry(proc, container) {
            const entry = document.createElement('div');
            entry.className = 'process-entry';
            
            if (proc.cpu > 50 || proc.reason.includes('Comando sospechoso')) {
                entry.classList.add('critical');
            } else {
                entry.classList.add('high');
            }
            
            const pidSpan = document.createElement('div');
            pidSpan.className = 'process-pid';
            pidSpan.textContent = `PID: ${proc.pid}`;
            entry.appendChild(pidSpan);
            
            const metricsSpan = document.createElement('div');
            metricsSpan.className = 'process-metrics';
            metricsSpan.textContent = `CPU: ${proc.cpu}% | MEM: ${proc.mem}% | Tiempo: ${proc.time}`;
            entry.appendChild(metricsSpan);
            
            const commandSpan = document.createElement('div');
            commandSpan.className = 'process-command';
            commandSpan.textContent = proc.command;
            entry.appendChild(commandSpan);
            
            const reasonSpan = document.createElement('div');
            reasonSpan.className = 'process-reason';
            reasonSpan.textContent = `⚠️ ${proc.reason}`;
            entry.appendChild(reasonSpan);
            
            container.appendChild(entry);
        }
        
        function createCrontabEntry(cron, container) {
            const entry = document.createElement('div');
            entry.className = 'crontab-entry';
            
            const userSpan = document.createElement('div');
            userSpan.className = 'crontab-user';
            userSpan.textContent = `Usuario: ${cron.user}`;
            entry.appendChild(userSpan);
            
            const commandSpan = document.createElement('div');
            commandSpan.className = 'crontab-command';
            commandSpan.textContent = cron.cron;
            entry.appendChild(commandSpan);
            
            container.appendChild(entry);
        }
        
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }
        
        function updateHealth(data) {
            const cpuEl = document.getElementById('cpu');
            const memEl = document.getElementById('mem');
            
            const cpu = parseFloat(data.cpu) || 0;
            const mem = parseFloat(data.mem) || 0;
            
            cpuEl.textContent = cpu.toFixed(1) + '%';
            memEl.textContent = mem.toFixed(1) + '%';
            
            // Cambiar color según el uso
            cpuEl.className = 'stats';
            memEl.className = 'stats';
            
            if (cpu > 80) cpuEl.classList.add('danger');
            else if (cpu > 60) cpuEl.classList.add('warning');
            
            if (mem > 80) memEl.classList.add('danger');
            else if (mem > 60) memEl.classList.add('warning');
        }
        
        function updateNetwork(data, skipEmptyCheck = false) {
            const netEl = document.getElementById('net');
            const threatEl = document.getElementById('threat');
            
            // Limpiar empty state si existe (solo si no estamos cargando historial)
            if (!skipEmptyCheck && netEl.querySelector('.empty-state')) {
                netEl.innerHTML = '';
            }
            
            // Si data es un string, parsearlo; si es un objeto con data, usar data.data
            const networkData = typeof data === 'string' ? data : (data.data || data);
            const lines = networkData.split('\n').filter(line => line.trim());
            let hasThreat = false;
            let threatLevel = 'BAJA';
            
            // Actualizar systemData para la IA
            lines.forEach(line => {
                if (line.trim()) {
                    const risk = line.includes('SYN-SENT') || line.includes('SYN_SENT') ? 'critical' :
                               (line.includes('php') || line.includes('python') || line.includes('perl')) && 
                               /(\d{1,3}\.){3}\d{1,3}/.test(line) && !line.includes('127.0.0.1') ? 'high' : 'medium';
                    systemData.network.push({
                        detail: line,
                        risk: risk,
                        timestamp: Date.now()
                    });
                    if (systemData.network.length > 50) systemData.network.shift();
                }
            });
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                const entry = document.createElement('div');
                entry.className = 'network-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'network-timestamp';
                timestampSpan.textContent = `[${timestamp}]`;
                entry.appendChild(timestampSpan);
                
                // Detectar tipo de conexión y nivel de amenaza
                let riskLevel = 'safe';
                let stateClass = '';
                let stateText = '';
                
                if (line.includes('SYN-SENT') || line.includes('SYN_SENT')) {
                    riskLevel = 'critical';
                    hasThreat = true;
                    threatLevel = 'CRÍTICA';
                    stateClass = 'syn-sent';
                    stateText = 'SYN-SENT';
                } else if (line.includes('ESTAB') || line.includes('ESTABLISHED')) {
                    // Verificar si es conexión externa sospechosa
                    const hasExternalIP = /(\d{1,3}\.){3}\d{1,3}/.test(line);
                    const isLocalhost = line.includes('127.0.0.1') || line.includes('::1');
                    
                    if (hasExternalIP && !isLocalhost) {
                        // Verificar si es PHP u otro proceso sospechoso
                        if (line.includes('php') || line.includes('python') || line.includes('perl')) {
                            riskLevel = 'danger';
                            hasThreat = true;
                            if (threatLevel !== 'CRÍTICA') threatLevel = 'ALTA';
                        } else {
                            riskLevel = 'warning';
                            if (threatLevel === 'BAJA') threatLevel = 'MEDIA';
                        }
                    }
                    stateClass = 'estab';
                    stateText = 'ESTAB';
                } else if (line.includes('LISTEN')) {
                    stateClass = 'listen';
                    stateText = 'LISTEN';
                }
                
                entry.classList.add(riskLevel);
                
                // Extraer información de la línea
                const protocolMatch = line.match(/(tcp|udp|tcp6|udp6)/i);
                const protocol = protocolMatch ? protocolMatch[1].toUpperCase() : 'TCP';
                
                const protocolSpan = document.createElement('span');
                protocolSpan.className = 'network-protocol';
                protocolSpan.textContent = protocol;
                entry.appendChild(protocolSpan);
                
                if (stateText) {
                    const stateSpan = document.createElement('span');
                    stateSpan.className = `network-state ${stateClass}`;
                    stateSpan.textContent = stateText;
                    entry.appendChild(stateSpan);
                }
                
                // Agregar información de la conexión
                const infoSpan = document.createElement('span');
                infoSpan.style.marginLeft = '8px';
                infoSpan.style.color = '#c9d1d9';
                
                // Limpiar y formatear la información
                let cleanLine = line.replace(/\s+/g, ' ').trim();
                // Remover información redundante
                cleanLine = cleanLine.replace(/users:\([^)]+\)/g, '').trim();
                infoSpan.textContent = cleanLine;
                entry.appendChild(infoSpan);
                
                // Insertar al principio
                if (netEl.firstChild) {
                    netEl.insertBefore(entry, netEl.firstChild);
                } else {
                    netEl.appendChild(entry);
                }
            });
            
            // Limitar a 50 entradas
            while (netEl.children.length > 50) {
                netEl.removeChild(netEl.lastChild);
            }
            
            // Actualizar nivel de amenaza
            threatEl.textContent = threatLevel;
            if (hasThreat) {
                threatEl.className = 'stats danger';
            } else if (threatLevel === 'MEDIA') {
                threatEl.className = 'stats warning';
            } else {
                threatEl.className = 'stats warning';
            }
        }
        
        function updateFiles(data, skipEmptyCheck = false) {
            const fileEl = document.getElementById('file');
            
            // Limpiar empty state si existe (solo si no estamos cargando historial)
            if (!skipEmptyCheck && fileEl.querySelector('.empty-state')) {
                fileEl.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            
            // Determinar nivel de riesgo
            const risk = data.risk || 'low';
            entry.classList.add(risk);
            
            const timestamp = new Date(data.ts).toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'file-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            entry.appendChild(timestampSpan);
            
            // Información del archivo
            const filePath = data.filePath || data.detail.split(' ')[0] || data.detail;
            const events = data.events || (data.detail.includes('MODIFY') ? 'MODIFY' : 
                          data.detail.includes('CREATE') ? 'CREATE' : 
                          data.detail.includes('DELETE') ? 'DELETE' : 'MODIFY');
            
            const pathSpan = document.createElement('span');
            pathSpan.className = 'file-path';
            pathSpan.textContent = filePath;
            entry.appendChild(pathSpan);
            
            // Badge de evento
            const eventSpan = document.createElement('span');
            eventSpan.className = `file-event ${events.toLowerCase()}`;
            eventSpan.textContent = events;
            entry.appendChild(eventSpan);
            
            // Mostrar proceso que modificó el archivo
            if (data.process && data.process.pid) {
                const processSpan = document.createElement('div');
                processSpan.style.cssText = 'margin-top: 4px; font-size: 0.8rem; color: #8b949e;';
                processSpan.innerHTML = `🔧 Proceso: <strong style="color: #58a6ff;">${data.process.command}</strong> (PID: ${data.process.pid}, Usuario: ${data.process.user})`;
                entry.appendChild(processSpan);
            }
            
            // Insertar al principio
            if (fileEl.firstChild) {
                fileEl.insertBefore(entry, fileEl.firstChild);
            } else {
                fileEl.appendChild(entry);
            }
            
            // Limitar a 50 entradas
            while (fileEl.children.length > 50) {
                fileEl.removeChild(fileEl.lastChild);
            }
            
            // Actualizar systemData para la IA
            systemData.files.push(data);
            if (systemData.files.length > 50) systemData.files.shift();
        }
        
        function triggerPanic() {
            if (confirm('⚠️ ¿Estás seguro de activar el PROTOCOLO DE PÁNICO?\n\nEsto bloqueará todas las conexiones salientes excepto SSH y localhost.')) {
                if (socket && socket.connected) {
                    socket.emit('panic_action');
                    showToast('Protocolo de Pánico', 'Protocolo de pánico activado', 'error', 0);
                } else {
                    showToast('Error', 'No hay conexión con el servidor', 'error');
                }
            }
        }
        
        function showAlert(message, type = 'info') {
            // Usar toast en lugar de alert antiguo
            showToast(type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Información', message, type);
        }
        
        function updateSites(sites) {
            sitesData = sites;
            // Actualizar systemData para la IA
            systemData.sites = sites || [];
            const grid = document.getElementById('sitesGrid');
            
            // Limpiar grid
            grid.innerHTML = '';
            
            if (sites.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8b949e;">🔍 No se encontraron sitios web</div>';
                return;
            }
            
            // Contar por estado
            const active = sites.filter(s => s.status === 'active').length;
            const errors = sites.filter(s => s.status === 'error').length;
            const down = sites.filter(s => s.status === 'down').length;
            
            // Actualizar resumen
            document.getElementById('sitesActive').textContent = active;
            document.getElementById('sitesError').textContent = errors;
            document.getElementById('sitesDown').textContent = down;
            
            // Crear tarjetas de sitios
            sites.forEach(site => {
                const card = document.createElement('div');
                card.className = `site-card ${site.status}`;
                
                const statusText = {
                    'active': 'Activo',
                    'error': 'Error',
                    'down': 'Caído',
                    'unknown': 'Desconocido'
                };
                
                card.innerHTML = `
                    <div class="site-header">
                        <div class="site-domain">${site.domain}</div>
                        <div class="site-status ${site.status}">${statusText[site.status] || 'Desconocido'}</div>
                    </div>
                    <div class="site-info">
                        <div class="site-info-item">
                            <span class="site-info-label">URL:</span>
                            <span class="site-info-value">${site.url}</span>
                        </div>
                        ${site.statusCode ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Código HTTP:</span>
                            <span class="site-info-value">${site.statusCode}</span>
                        </div>
                        ` : ''}
                        ${site.responseTime !== null ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Tiempo de respuesta:</span>
                            <span class="site-info-value">${site.responseTime}ms</span>
                        </div>
                        ` : ''}
                        ${site.lastCheck ? `
                        <div class="site-info-item">
                            <span class="site-info-label">Última verificación:</span>
                            <span class="site-info-value">${new Date(site.lastCheck).toLocaleTimeString()}</span>
                        </div>
                        ` : ''}
                        ${site.error ? `
                        <div class="site-info-item" style="color: #da3633; margin-top: 8px;">
                            <span>⚠️ ${site.error}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function handleSitesAlert(data) {
            const { changed, down, errors } = data;
            
            // Solo notificar sitios que cambiaron de estado
            if (changed && changed.length > 0) {
                changed.forEach(site => {
                    if (site.status === 'down') {
                        showToast('Sitio Caído', `${site.domain} cambió de ${site.previousStatus} a CAÍDO`, 'error', 10000);
                    } else if (site.status === 'error') {
                        showToast('Error en Sitio', `${site.domain} cambió a estado ERROR: ${site.error || 'Error desconocido'}`, 'warning', 8000);
                    } else if (site.status === 'active' && site.previousStatus !== 'active') {
                        showToast('Sitio Recuperado', `${site.domain} está ahora ACTIVO`, 'success', 5000);
                    }
                });
            }
        }
        
        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
        });
        
        function updateProcesses(processes, skipEmptyCheck = false) {
            const processEl = document.getElementById('process');
            
            // Limpiar empty state si existe (solo si no estamos cargando historial)
            if (!skipEmptyCheck && processEl.querySelector('.empty-state')) {
                processEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas solo si no estamos cargando historial
            if (!skipEmptyCheck) {
                processEl.innerHTML = '';
            }
            
            processes.forEach(proc => {
                const entry = document.createElement('div');
                entry.className = 'process-entry';
                
                // Determinar nivel de riesgo
                if (proc.cpu > 50 || proc.reason.includes('Comando sospechoso')) {
                    entry.classList.add('critical');
                } else {
                    entry.classList.add('high');
                }
                
                const pidSpan = document.createElement('div');
                pidSpan.className = 'process-pid';
                pidSpan.textContent = `PID: ${proc.pid}`;
                entry.appendChild(pidSpan);
                
                const metricsSpan = document.createElement('div');
                metricsSpan.className = 'process-metrics';
                metricsSpan.textContent = `CPU: ${proc.cpu}% | MEM: ${proc.mem}% | Tiempo: ${proc.time}`;
                entry.appendChild(metricsSpan);
                
                const commandSpan = document.createElement('div');
                commandSpan.className = 'process-command';
                commandSpan.textContent = proc.command;
                entry.appendChild(commandSpan);
                
                const reasonSpan = document.createElement('div');
                reasonSpan.className = 'process-reason';
                reasonSpan.textContent = `⚠️ ${proc.reason}`;
                entry.appendChild(reasonSpan);
                
                processEl.appendChild(entry);
            });
            
            // Actualizar systemData para la IA
            systemData.processes = processes;
            
            // Actualizar nivel de amenaza si hay procesos sospechosos
            if (processes.length > 0) {
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                
                // Solo mostrar toast si el número de procesos cambió o han pasado más de 30 segundos
                const now = Date.now();
                if (processes.length !== lastProcessCount || !lastProcessToast || (now - lastProcessToast) > 30000) {
                    showToast('Procesos Sospechosos', `Se detectaron ${processes.length} proceso(s) PHP sospechoso(s)`, 'error');
                    lastProcessToast = now;
                    lastProcessCount = processes.length;
                }
            }
        }
        
        function updateCrontab(crontabs, skipEmptyCheck = false) {
            const crontabEl = document.getElementById('crontab');
            
            // Limpiar empty state si existe (solo si no estamos cargando historial)
            if (!skipEmptyCheck && crontabEl.querySelector('.empty-state')) {
                crontabEl.innerHTML = '';
            }
            
            // Limpiar entradas antiguas solo si no estamos cargando historial
            if (!skipEmptyCheck) {
                crontabEl.innerHTML = '';
            }
            
            // Actualizar systemData para la IA
            systemData.crontab = crontabs || [];
            
            if (crontabs && crontabs.length > 0) {
                crontabs.forEach(cron => {
                    const entry = document.createElement('div');
                    entry.className = 'crontab-entry';
                    
                    const userSpan = document.createElement('div');
                    userSpan.className = 'crontab-user';
                    userSpan.textContent = `Usuario: ${cron.user}`;
                    entry.appendChild(userSpan);
                    
                    const commandSpan = document.createElement('div');
                    commandSpan.className = 'crontab-command';
                    commandSpan.textContent = cron.cron;
                    entry.appendChild(commandSpan);
                    
                    crontabEl.appendChild(entry);
                });
                
                // Actualizar nivel de amenaza si hay crontabs sospechosos
                const threatEl = document.getElementById('threat');
                threatEl.textContent = 'CRÍTICA';
                threatEl.className = 'stats danger';
                showToast('Crontab Sospechoso', `Se detectaron ${crontabs.length} tarea(s) sospechosa(s) en crontab`, 'error');
            } else {
                // Mostrar mensaje cuando no hay tareas sospechosas
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-state';
                emptyMsg.textContent = 'No se detectaron tareas sospechosas en crontab';
                crontabEl.appendChild(emptyMsg);
            }
        }
        
        // Variables para IA
        let aiConversationHistory = [];
        let systemData = {
            processes: [],
            network: [],
            files: [],
            crontab: [],
            sites: [],
            health: { cpu: 0, mem: 0 }
        };
        
        // Tracking de toasts para evitar duplicados
        let lastProcessToast = null;
        let lastProcessCount = 0;
        
        // Recopilar datos del sistema para enviar a la IA
        function collectSystemData() {
            // Asegurar que todos los campos sean arrays
            const processes = Array.isArray(systemData.processes) ? systemData.processes : [];
            const files = Array.isArray(systemData.files) ? systemData.files : [];
            const network = Array.isArray(systemData.network) ? systemData.network : [];
            const crontab = Array.isArray(systemData.crontab) ? systemData.crontab : [];
            const sites = Array.isArray(systemData.sites) ? systemData.sites : [];
            
            // Preparar datos detallados para la IA
            const procesosDetallados = processes.map(p => ({
                pid: p.pid,
                comando: p.command,
                cpu: p.cpu,
                memoria: p.mem,
                tiempo_ejecucion: p.time,
                razon_sospechosa: p.reason,
                usuario: p.user || 'desconocido'
            }));
            
            const archivosDetallados = files.map(f => ({
                ruta: f.filePath || (f.detail ? (typeof f.detail === 'string' ? f.detail.split(' ')[0] : f.detail) : 'desconocido'),
                evento: f.events || 'MODIFY',
                riesgo: f.risk || 'medium',
                timestamp: f.ts || f.timestamp || Date.now(),
                proceso_modificador: f.process ? {
                    pid: f.process.pid,
                    comando: f.process.command,
                    usuario: f.process.user
                } : null
            }));
            
            const conexionesDetalladas = network.map(n => ({
                conexion: n.detail || (typeof n === 'string' ? n : JSON.stringify(n)),
                timestamp: n.ts || n.timestamp || Date.now(),
                riesgo: n.risk || 'medium'
            }));
            
            const crontabsDetallados = crontab.map(c => ({
                usuario: c.user || 'desconocido',
                tarea: c.cron || c.command || 'desconocido',
                timestamp: c.timestamp || Date.now()
            }));
            
            return {
                resumen: {
                    total_procesos_sospechosos: procesosDetallados.length,
                    total_archivos_modificados: archivosDetallados.length,
                    total_conexiones_sospechosas: conexionesDetalladas.length,
                    total_tareas_crontab: crontabsDetallados.length,
                    sitios_web_caidos: sites.filter(s => s && s.status !== 'active').length
                },
                procesos_sospechosos: procesosDetallados,
                archivos_modificados: archivosDetallados,
                conexiones_red: conexionesDetalladas,
                tareas_crontab: crontabsDetallados,
                sitios_web: sites.filter(s => s && s.status !== 'active').map(s => ({
                    dominio: s.domain || 'desconocido',
                    estado: s.status || 'desconocido',
                    error: s.error || null,
                    ultima_verificacion: s.lastCheck || null
                })),
                recursos_sistema: {
                    cpu: systemData.health?.cpu || 0,
                    memoria: systemData.health?.mem || 0,
                    timestamp: systemData.health?.ts || Date.now()
                },
                timestamp: new Date().toISOString()
            };
        }
        
        // Generar análisis completo de IA
        async function generateAIAnalysis() {
            const chatEl = document.getElementById('aiChat');
            const model = document.getElementById('aiModel').value;
            
            // Agregar mensaje de usuario
            addAIMessage('user', 'Genera un análisis completo del sistema con instrucciones de reconocimiento y mitigación de amenazas.');
            
            // Mostrar loading
            const loadingMsg = addAIMessage('assistant', '🔍 Analizando datos del sistema...', true);
            
            try {
                const collectedData = collectSystemData();
                
                // Validar que hay datos antes de analizar - usar los datos recopilados
                const hasData = collectedData.resumen.total_procesos_sospechosos > 0 || 
                               collectedData.resumen.total_archivos_modificados > 0 || 
                               collectedData.resumen.total_conexiones_sospechosas > 0 || 
                               collectedData.resumen.total_tareas_crontab > 0;
                
                // Debug: mostrar qué datos hay
                console.log('🔍 Datos recopilados para IA:', {
                    procesos: collectedData.resumen.total_procesos_sospechosos,
                    archivos: collectedData.resumen.total_archivos_modificados,
                    red: collectedData.resumen.total_conexiones_sospechosas,
                    crontab: collectedData.resumen.total_tareas_crontab,
                    hasData: hasData,
                    datosCompletos: {
                        procesosArray: collectedData.procesos_sospechosos.length,
                        archivosArray: collectedData.archivos_modificados.length,
                        redArray: collectedData.conexiones_red.length,
                        crontabArray: collectedData.tareas_crontab.length
                    },
                    systemDataOriginal: {
                        processes: systemData.processes.length,
                        files: systemData.files.length,
                        network: systemData.network.length,
                        crontab: systemData.crontab.length
                    }
                });
                
                if (!hasData) {
                    loadingMsg.remove();
                    addAIMessage('assistant', `⚠️ No hay datos sospechosos para analizar en este momento. 

Estadísticas actuales:
- Procesos sospechosos: ${collectedData.resumen.total_procesos_sospechosos}
- Archivos modificados: ${collectedData.resumen.total_archivos_modificados}
- Conexiones de red: ${collectedData.resumen.total_conexiones_sospechosas}
- Tareas crontab: ${collectedData.resumen.total_tareas_crontab}

El sistema está limpio o no se han detectado eventos recientes.`);
                    return;
                }
                
                const prompt = `Eres un analista SOC senior especializado en análisis forense y detección de amenazas. Tu trabajo es analizar los datos proporcionados y dar INSTRUCCIONES DIRECTAS Y ACCIONABLES.

FORMATO DE RESPUESTA OBLIGATORIO:
- Usa etiquetas <strong> para títulos y secciones importantes
- TODOS los comandos de Linux DEBEN estar dentro de etiquetas <code>comando</code>
- Sé DIRECTO y ESPECÍFICO, sin rodeos
- Proporciona instrucciones paso a paso claras

REGLAS CRÍTICAS:
1. NO proporciones consejos genéricos - solo análisis específico de los datos
2. Analiza CADA elemento en los arrays proporcionados
3. Para CADA comando que menciones, usa <code>comando</code>
4. Da instrucciones DIRECTAS: "Ejecuta...", "Verifica...", "Elimina..."
5. Ordena las acciones por prioridad (1, 2, 3...)

DATOS DEL SISTEMA A ANALIZAR:
${JSON.stringify(collectedData, null, 2)}

ESTRUCTURA DE RESPUESTA REQUERIDA:

<strong>1. ANÁLISIS INMEDIATO:</strong>
Para CADA elemento sospechoso encontrado, proporciona:
- Tipo de amenaza identificada
- Nivel de criticidad (CRÍTICO, ALTO, MEDIO)
- Qué está haciendo exactamente

<strong>2. INSTRUCCIONES DE INVESTIGACIÓN (Paso a Paso):</strong>
Para cada amenaza, proporciona comandos específicos usando <code>:

Ejemplo de formato:
"Para investigar el proceso PID 12345, ejecuta: <code>ps aux | grep 12345</code>
Luego verifica sus conexiones: <code>lsof -p 12345</code>
Si es malicioso, deténlo con: <code>kill -9 12345</code>"

<strong>3. INSTRUCCIONES DE MITIGACIÓN (Orden de Prioridad):</strong>
Lista las acciones en orden de prioridad, cada una con su comando en <code>:

1. [Acción crítica] - Ejecuta: <code>comando1</code>
2. [Acción importante] - Ejecuta: <code>comando2</code>
3. [Acción preventiva] - Ejecuta: <code>comando3</code>

<strong>4. VERIFICACIÓN POST-MITIGACIÓN:</strong>
Comandos para verificar que la amenaza fue eliminada, todos en <code>

ANÁLISIS DETALLADO REQUERIDO:

PROCESOS SOSPECHOSOS (${collectedData.resumen.total_procesos_sospechosos}):
${collectedData.procesos_sospechosos.length > 0 ? 
  collectedData.procesos_sospechosos.map(p => 
    `- PID ${p.pid}: ${p.comando} (Razón: ${p.razon_sospechosa}, CPU: ${p.cpu}%, Mem: ${p.memoria}%)`
  ).join('\n') : 
  'Ninguno detectado'}

ARCHIVOS MODIFICADOS (${collectedData.resumen.total_archivos_modificados}):
${collectedData.archivos_modificados.length > 0 ? 
  collectedData.archivos_modificados.slice(0, 10).map(f => 
    `- ${f.ruta} (Evento: ${f.evento}, Riesgo: ${f.riesgo})`
  ).join('\n') : 
  'Ninguno detectado'}

CONEXIONES DE RED (${collectedData.resumen.total_conexiones_sospechosas}):
${collectedData.conexiones_red.length > 0 ? 
  collectedData.conexiones_red.slice(0, 10).map(c => 
    `- ${c.conexion} (Riesgo: ${c.riesgo})`
  ).join('\n') : 
  'Ninguna detectada'}

TAREAS CRONTAB (${collectedData.resumen.total_tareas_crontab}):
${collectedData.tareas_crontab.length > 0 ? 
  collectedData.tareas_crontab.map(c => 
    `- Usuario ${c.usuario}: ${c.tarea}`
  ).join('\n') : 
  'Ninguna detectada'}

IMPORTANTE:
- TODOS los comandos deben estar en etiquetas <code>
- Sé ESPECÍFICO con cada proceso, archivo y conexión
- Da instrucciones DIRECTAS, no sugerencias
- Ordena por prioridad (lo más crítico primero)
- Explica brevemente QUÉ hace cada comando antes de proporcionarlo

Responde en español, de forma clara, estructurada y con TODOS los comandos en etiquetas <code>.`;
                
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        modelo: model
                    })
                });
                
                console.log('Enviando a IA:', {
                    promptLength: prompt.length,
                    datos: {
                        procesos: collectedData.procesos_sospechosos.length,
                        archivos: collectedData.archivos_modificados.length,
                        red: collectedData.conexiones_red.length,
                        crontab: collectedData.tareas_crontab.length
                    }
                });
                
                const data = await response.json();
                
                // Remover mensaje de loading
                loadingMsg.remove();
                
                if (data.success && data.respuesta) {
                    addAIMessage('assistant', data.respuesta);
                    aiConversationHistory.push({ role: 'user', content: prompt });
                    aiConversationHistory.push({ role: 'assistant', content: data.respuesta });
                } else {
                    addAIMessage('assistant', '❌ Error al obtener respuesta de la IA: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                loadingMsg.remove();
                addAIMessage('assistant', '❌ Error al conectar con la IA: ' + error.message);
            }
        }
        
        // Enviar mensaje a la IA
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const model = document.getElementById('aiModel').value;
            
            // Agregar mensaje del usuario
            addAIMessage('user', message);
            input.value = '';
            
            // Mostrar loading
            const loadingMsg = addAIMessage('assistant', '💭 Pensando...', true);
            
            try {
                // Construir prompt con contexto de la conversación
                let contextPrompt = message;
                
                if (aiConversationHistory.length > 0) {
                    contextPrompt = `Contexto de la conversación anterior:\n${aiConversationHistory.map(m => `${m.role}: ${m.content}`).join('\n\n')}\n\nNueva pregunta del usuario: ${message}`;
                }
                
                // Si la pregunta es sobre el sistema, agregar datos actuales
                if (message.toLowerCase().includes('sistema') || message.toLowerCase().includes('amenaza') || message.toLowerCase().includes('ataque') || message.toLowerCase().includes('proceso') || message.toLowerCase().includes('archivo') || message.toLowerCase().includes('red') || message.toLowerCase().includes('comando') || message.toLowerCase().includes('ejecutar')) {
                    const currentSystemData = collectSystemData();
                    contextPrompt += `\n\nIMPORTANTE: 
- Analiza SOLO estos datos reales del sistema
- No des consejos genéricos
- Si mencionas comandos, usa etiquetas <code>comando</code>
- Da instrucciones DIRECTAS y específicas
- Ordena las acciones por prioridad

Datos actuales del sistema:
${JSON.stringify(currentSystemData, null, 2)}`;
                } else {
                    // Para cualquier pregunta, recordar usar <code> para comandos
                    contextPrompt += `\n\nNOTA: Si mencionas comandos de Linux o instrucciones técnicas, usa etiquetas <code>comando</code> para formatearlos correctamente.`;
                }
                
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: contextPrompt,
                        modelo: model
                    })
                });
                
                const data = await response.json();
                
                // Remover mensaje de loading
                loadingMsg.remove();
                
                if (data.success && data.respuesta) {
                    addAIMessage('assistant', data.respuesta);
                    aiConversationHistory.push({ role: 'user', content: message });
                    aiConversationHistory.push({ role: 'assistant', content: data.respuesta });
                } else {
                    addAIMessage('assistant', '❌ Error al obtener respuesta de la IA: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                loadingMsg.remove();
                addAIMessage('assistant', '❌ Error al conectar con la IA: ' + error.message);
            }
        }
        
        // Agregar mensaje al chat
        function addAIMessage(role, content, isLoading = false) {
            const chatEl = document.getElementById('aiChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            
            if (role === 'user') {
                messageDiv.style.cssText = 'padding: 10px; margin-bottom: 10px; background: rgba(63, 185, 80, 0.1); border-left: 3px solid #3fb950; border-radius: 4px;';
                messageDiv.innerHTML = `<strong style="color: #3fb950;">👤 Tú:</strong><div style="margin-top: 5px; color: #c9d1d9; white-space: pre-wrap;">${escapeHtml(content)}</div>`;
            } else {
                messageDiv.style.cssText = 'padding: 10px; margin-bottom: 10px; background: rgba(88, 166, 255, 0.1); border-left: 3px solid #58a6ff; border-radius: 4px;';
                if (isLoading) {
                    messageDiv.innerHTML = `<strong style="color: #58a6ff;">🤖 Asistente:</strong><div style="margin-top: 5px; color: #8b949e; font-style: italic;">${content}</div>`;
                } else {
                    messageDiv.innerHTML = `<strong style="color: #58a6ff;">🤖 Asistente:</strong><div style="margin-top: 5px; color: #c9d1d9; line-height: 1.6;">${formatAIMessage(content)}</div>`;
                }
            }
            
            chatEl.appendChild(messageDiv);
            chatEl.scrollTop = chatEl.scrollHeight;
            
            return messageDiv;
        }
        
        // Formatear mensaje de IA (markdown básico y HTML)
        function formatAIMessage(text) {
            if (!text) return '';
            
            // Preservar etiquetas HTML seguras que ya vienen en el texto de la IA
            const safeTags = ['strong', 'code', 'pre', 'ul', 'ol', 'li', 'p', 'br', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
            const placeholders = [];
            let placeholderIndex = 0;
            
            // Reemplazar etiquetas HTML seguras con placeholders temporales
            // Procesar en orden inverso para manejar etiquetas anidadas
            safeTags.reverse().forEach(tag => {
                // Regex mejorado para capturar etiquetas incluso con contenido complejo
                const regex = new RegExp(`<${tag}([^>]*)>([\\s\\S]*?)<\\/${tag}>`, 'gi');
                let match;
                while ((match = regex.exec(text)) !== null) {
                    const fullMatch = match[0];
                    const attrs = match[1] || '';
                    const content = match[2] || '';
                    const placeholder = `__HTML_PLACEHOLDER_${placeholderIndex}__`;
                    
                    placeholders[placeholderIndex] = { 
                        tag, 
                        attrs: attrs.trim(), 
                        content: content,
                        original: fullMatch 
                    };
                    
                    // Reemplazar en el texto
                    text = text.substring(0, match.index) + placeholder + text.substring(match.index + fullMatch.length);
                    
                    // Reiniciar el regex para buscar desde el principio
                    regex.lastIndex = 0;
                    placeholderIndex++;
                }
            });
            
            // Escapar el resto del HTML para seguridad
            text = escapeHtml(text);
            
            // Restaurar etiquetas HTML preservadas con estilos mejorados
            placeholders.forEach((tagInfo, index) => {
                const placeholder = `__HTML_PLACEHOLDER_${index}__`;
                let replacement = '';
                
                switch(tagInfo.tag.toLowerCase()) {
                    case 'strong':
                        // Aplicar formato mejorado a strong - más visible y destacado
                        replacement = `<strong style="color: #58a6ff; font-weight: bold; font-size: 1.05em; display: inline-block; margin: 2px 0;">${tagInfo.content}</strong>`;
                        break;
                    case 'code':
                        replacement = `<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; color: #c9d1d9; font-family: 'Courier New', monospace; font-size: 0.9em;">${tagInfo.content}</code>`;
                        break;
                    case 'pre':
                        replacement = `<pre style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 4px; overflow-x: auto; margin: 10px 0; border-left: 3px solid #58a6ff;"><code style="color: #c9d1d9; font-family: 'Courier New', monospace; font-size: 0.85em; white-space: pre;">${tagInfo.content}</code></pre>`;
                        break;
                    default:
                        replacement = tagInfo.original;
                }
                
                // Reemplazar placeholder con el HTML formateado
                text = text.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacement);
            });
            
            // Convertir markdown a HTML
            // Negrita markdown **texto**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #58a6ff; font-weight: bold;">$1</strong>');
            
            // Números de lista con formato mejorado (1. texto)
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 10px 0 8px 0;"><strong style="color: #58a6ff; font-size: 1.05em; font-weight: bold;">$1.</strong> <span style="color: #c9d1d9; margin-left: 5px;">$2</span></div>');
            
            // Preservar etiquetas code existentes primero
            const codePlaceholders = [];
            let codePlaceholderIndex = 0;
            text = text.replace(/<code[^>]*>([\s\S]*?)<\/code>/gi, (match, content) => {
                const placeholder = `__CODE_PLACEHOLDER_${codePlaceholderIndex}__`;
                codePlaceholders[codePlaceholderIndex] = { content, placeholder };
                codePlaceholderIndex++;
                return placeholder;
            });
            
            // Código inline markdown `código`
            text = text.replace(/`([^`\n]+)`/g, (match, code) => {
                return `<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; color: #c9d1d9; font-family: 'Courier New', monospace; font-size: 0.9em;">${code}</code>`;
            });
            
            // Detectar comandos que empiezan con $ o # (prompt de shell) - formato mejorado
            text = text.replace(/(?:^|\s|>|:)(\$|#)\s+([a-zA-Z0-9_\/\.\-\s\|<>'"`]+?)(?=\s*$|\s*<[^c]|\s*\.\s|\s*,\s|\s*;\s|\s*:\s|\s*\n\n|$)/gm, (match, prompt, command) => {
                const trimmedCommand = command.trim();
                // Solo formatear si parece un comando válido (más de 2 caracteres, contiene letras)
                if (trimmedCommand.length > 2 && /[a-zA-Z]/.test(trimmedCommand) && !trimmedCommand.includes('<code')) {
                    return ` <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; color: #c9d1d9; font-family: 'Courier New', monospace; font-size: 0.9em;">${prompt} ${trimmedCommand}</code>`;
                }
                return match;
            });
            
            // Restaurar etiquetas code preservadas
            codePlaceholders.forEach(placeholder => {
                text = text.replace(placeholder.placeholder, `<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; color: #c9d1d9; font-family: 'Courier New', monospace; font-size: 0.9em;">${placeholder.content}</code>`);
            });
            
            // Bloques de código markdown ```código```
            text = text.replace(/```([\s\S]*?)```/g, '<pre style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 4px; overflow-x: auto; margin: 10px 0; border-left: 3px solid #58a6ff;"><code style="color: #c9d1d9; font-family: \'Courier New\', monospace; font-size: 0.85em; white-space: pre;">$1</code></pre>');
            
            // Listas con viñetas (- o *)
            const lines = text.split('\n');
            let inList = false;
            let listContent = '';
            const processedLines = [];
            
            lines.forEach(line => {
                const listMatch = line.match(/^[-*]\s+(.+)$/);
                if (listMatch) {
                    if (!inList) {
                        inList = true;
                        listContent = '';
                    }
                    listContent += `<li style="margin: 4px 0; color: #c9d1d9; padding-left: 5px;">${listMatch[1]}</li>`;
                } else {
                    if (inList) {
                        processedLines.push(`<ul style="margin: 10px 0; padding-left: 25px; color: #c9d1d9; list-style-type: disc;">${listContent}</ul>`);
                        listContent = '';
                        inList = false;
                    }
                    processedLines.push(line);
                }
            });
            
            if (inList) {
                processedLines.push(`<ul style="margin: 10px 0; padding-left: 25px; color: #c9d1d9; list-style-type: disc;">${listContent}</ul>`);
            }
            
            text = processedLines.join('\n');
            
            // Saltos de línea (convertir \n a <br> pero preservar párrafos)
            text = text.replace(/\n\n+/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        // Escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Actualizar datos del sistema cuando lleguen nuevos datos (ya se actualiza en las funciones update)
        socket?.on('ui_sites', (data) => {
            if (data && Array.isArray(data)) {
                systemData.sites = data;
            }
        });
        
        socket?.on('ui_health', (data) => {
            if (data) {
                systemData.health = data;
            }
        });
        
        // Manejar cierre de página
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
